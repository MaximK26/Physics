/*! Test pack 0.1 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("THREE")):"function"==typeof define&&define.amd?define(["THREE"],e):"object"==typeof exports?exports.PHYSICS=e(require("THREE")):t.PHYSICS=e(t.THREE)}(window,function(t){return function(t){var e={};function i(o){if(e[o])return e[o].exports;var r=e[o]={i:o,l:!1,exports:{}};return t[o].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=t,i.c=e,i.d=function(t,e,o){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(i.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(o,r,function(e){return t[e]}.bind(null,r));return o},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=1)}([function(e,i){e.exports=t},function(t,e,i){"use strict";i.r(e);var o=i(0);class r{constructor(t){t=t||{},this.position=(new o.Vector3).copy(t.position)||new o.Vector3,this.quaternion=(new o.Quaternion).copy(t.quaternion)||new o.Quaternion}pointToLocal(t,e){return r.pointToLocalFrame(this.position,this.quaternion,t,e)}pointToWorld(t,e){return r.pointToWorldFrame(this.position,this.quaternion,t,e)}vectorToWorldFrame(t,e){return(new o.Vector3).copy(t).applyQuaternion(this.quaternion)}}r.pointToLocalFrame=function(t,e,i,r){var s=(new o.Quaternion).copy(e).conjugate();return(new o.Vector3).subVectors(i,t).applyQuaternion(s)},r.pointToWorldFrame=function(t,e,i,r){return(r=(new o.Vector3).copy(i).applyQuaternion(e)).addVectors(t,r),r},r.vectorToWorldFrame=function(t,e,i){return(new o.Vector).copy(e).applyQuaternion(t)},r.vectorToLocalFrame=function(t,e,i,r){r=(new o.Vector3).copy(i);return e.w*=-1,r.applyQuaternion(e),e.w*=-1,r},r.setRotationFromQuaternion=function(t,e){var i=e.x,o=e.y,r=e.z,s=e.w,n=i+i,a=o+o,l=r+r,c=i*n,h=i*a,u=i*l,p=o*a,d=o*l,v=r*l,y=s*n,m=s*a,f=s*l,w=t.elements;return w[0]=1-(p+v),w[1]=h-f,w[2]=u+m,w[3]=h+f,w[4]=1-(c+v),w[5]=d-y,w[6]=u-m,w[7]=d+y,w[8]=1-(c+p),t.elements=w,t};class s{constructor(){this.spatial=new o.Vector3,this.rotational=new o.Vector3}multiplyElement(t){return t.spatial.dot(this.spatial)+t.rotational.dot(this.rotational)}multiplyVectors(t,e){return t.dot(this.spatial)+e.dot(this.rotational)}}class n{constructor(t){t=t||{},this.id=n.IDCounter++,this.type=t.type||n.types.DUMMY,this.boundingSphereRadius=0,this.collisionResponse=t.collisionResponse||!0,this.collisionFilterGroup=t.collisionFilterGroup||1,this.collisionFilterMask=t.collisionFilterMask||-1,this.material=t.material||null,this.body=null}updateBoundingSphereRadius(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type}volume(){throw"volume() not implemented for shape type "+this.type}calculateLocalInertia(t,e){throw"calculateLocalInertia() not implemented for shape type "+this.type}}n.IDCounter=0,n.types={DUMMY:0,SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256};class l extends n{constructor(t){if(super({type:n.types.CONVEXPOLYHEDRON}),this.geometry=t||!1,!this.geometry)throw"Нет входных данных!";if(!t.isBufferGeometry)throw"Не верные входные данные!\n new PHYSICS.ConvexPolyhedron(THREE.BufferGeometry)";this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faceNormals=[],this.computeNormals()}get verticesLength(){return this.geometry.attributes.position.count}get facesLength(){return this.geometry.index.count/3}getVertex(t){let e=3*t;return new o.Vector3(this.geometry.attributes.position.array[e+0],this.geometry.attributes.position.array[e+1],this.geometry.attributes.position.array[e+2])}setVertex(t,e){let i=3*t;this.geometry.attributes.position.array[i+0]=e.x,this.geometry.attributes.position.array[i+1]=e.y,this.geometry.attributes.position.array[i+2]=e.z}getFace(t){let e=3*t;return[this.geometry.index.array[e+0],this.geometry.index.array[e+1],this.geometry.index.array[e+2]]}computeEdges(){var t=this.uniqueEdges;t.length=0;for(var e=0;e<this.facesLength;e++)for(var i=this.getFace(e),r=i.length,s=0;s<r;s++){var n=(s+1)%r;edge=(new o.Vector3).subVectors(getVertex(i[s]),getVertex(i[n])).normalize();for(var a=!1,l=0;l!==t.length;l++)if(t[l].almostEquals(edge)||t[l].almostEquals(edge)){a=!0;break}a||t.push(edge.clone())}}computeNormals(){this.faceNormals.length=this.facesLength;for(var t=0;t<this.facesLength;t++){var e=this.faceNormals[t]||new o.Vector3;(e=this.getFaceNormal(t)).negate(),this.faceNormals[t]=e;var i=this.getVertex(this.getFace(t)[0]);if(e.dot(i)<0){console.error(".faceNormals[${i}] = Vec3("+e.toString()+") looks like it points into the shape? The vertices follow.Make sure they are ordered CCW around the normal, using the right hand rule.");for(var r=0;r<this.getFace(t).length;r++)console.warn(".vertices["+this.getFace(t)[r]+"] = Vec3("+this.getVertex(this.getFace(t)[r]).toString()+")")}}}computeNormal(t,e,i){var r=(new o.Vector3).subVectors(i,e),s=(new o.Vector3).subVectors(e,t),n=(new o.Vector3).crossVectors(r,s);return n.equals(new o.Vector3)?new o.Vector3(0,1,0):n.normalize()}getFaceNormal(t){var e=this.getFace(t),i=this.getVertex(e[0]),o=this.getVertex(e[1]),r=this.getVertex(e[2]);return this.computeNormal(i,o,r)}clipAgainstHull(t,e,i,r,s,n,a,l,c){for(var h=new o.Vector3,u=-1,p=-Number.MAX_VALUE,d=0;d<i.facesLength;d++){h.copy(i.faceNormals[d]),h.applyQuaternion(s);var v=h.dot(n);v>p&&(p=v,u=d)}for(var y=[],m=i.getFace(u),f=m.length,w=0;w<f;w++){var b=i.getVertex(m[w]),g=(new o.Vector3).copy(b).applyQuaternion(s);g.addVectors(r,g),y.push(g)}u>=0&&this.clipFaceAgainstHull(n,t,e,y,a,l,c)}findSeparatingAxis(t,e,i,r,s,n,a,l){var c=new o.Vector3,h=new o.Vector3,u=new o.Vector3,p=new o.Vector3,d=new o.Vector3,v=new o.Vector3,y=Number.MAX_VALUE;if(curPlaneTests=0,this.uniqueAxes)for(f=0;f<this.uniqueAxes.length;f++){if(c.copy(this.uniqueAxes[f]).applyQuaternion(i),!1===(g=this.testSepAxis(c,t,e,i,r,s)))return!1;g<y&&(y=g,n.copy(c))}else for(var m=a?a.length:this.facesLength,f=0;f<m;f++){var w=a?a[f]:f;if(c.copy(this.faceNormals[w]).applyQuaternion(i),!1===(g=this.testSepAxis(c,t,e,i,r,s)))return!1;g<y&&(y=g,n.copy(c))}if(t.uniqueAxes)for(f=0;f<t.uniqueAxes.length;f++){if(h.copy(t.uniqueAxes[f]).applyQuaternion(s),curPlaneTests++,!1===(g=this.testSepAxis(h,t,e,i,r,s)))return!1;g<y&&(y=g,n.copy(h))}else for(var b=l?l.length:t.facesLength,f=0;f<b;f++){var g;w=l?l[f]:f;if(h.copy(t.faceNormals[w]).applyQuaternion(s),curPlaneTests++,!1===(g=this.testSepAxis(h,t,e,i,r,s)))return!1;g<y&&(y=g,n.copy(h))}for(var x=0;x<this.uniqueEdges.length;x++){p.copy(this.uniqueEdges[x]).applyQuaternion(i);for(var V=0;V<t.uniqueEdges.length;V++)if(d.copy(t.uniqueEdges[V]).applyQuaternion(s),v.crossVectors(p,d),!v.almostZero()){v.normalize();var B=this.testSepAxis(v,t,e,i,r,s);if(!1===B)return!1;B<y&&(y=B,n.copy(v))}}return u.subVectors(r,e),u.dot(n)>0&&n.negate(),!0}testSepAxis(t,e,i,o,r,s){var n=[],a=[];l.project(this,t,i,o,n),l.project(e,t,r,s,a);var c=n[0],h=n[1],u=a[0],p=a[1];if(c<p||u<h)return!1;var d=c-p,v=u-h;return d<v?d:v}calculateLocalInertia(t,e){var i=new o.Vector3,r=new o.Vector3;this.computeLocalAABB(i,r);var s=r.x-i.x,n=r.y-i.y,a=r.z-i.z;e.x=1/12*t*(2*n*2*n+2*a*2*a),e.y=1/12*t*(2*s*2*s+2*a*2*a),e.z=1/12*t*(2*n*2*n+2*s*2*s)}getPlaneConstantOfFace(t){var e=this.getFace(t),i=this.faceNormals[t],o=this.getVertex(e[0]);return-i.dot(o)}clipFaceAgainstHull(t,e,i,r,s,n,a){for(var l=new o.Vector3,c=new o.Vector3,h=new o.Vector3,u=new o.Vector3,p=new o.Vector3,d=new o.Vector3,v=new o.Vector3,y=new o.Vector3,m=r,f=[],w=-1,b=Number.MAX_VALUE,g=0;g<this.facesLength;g++){l.copy(this.faceNormals[g]).applyQuaternion(i);var x=l.dot(t);x<b&&(b=x,w=g)}if(!(w<0)){var V=this.faces[w];V.connectedFaces=[];for(var B=0;B<this.facesLength;B++)for(var E=0;E<this.getFace(B).length;E++)-1!==V.indexOf(this.getFace(B)[E])&&B!==w&&-1===V.connectedFaces.indexOf(B)&&V.connectedFaces.push(B);m.length;for(var A=V.length,S=0;S<A;S++){var F=this.getVertex(V[S]),M=this.getVertex(V[(S+1)%A]);c.subVectors(F,M),h.copy(c).applyRotationPosition(i,e),u.copy(this.faceNormals[w]).applyRotationPosition(i,e),p.crossVectors(h,u).negate(),d.copy(F).applyRotationPosition(i,e);d.dot(p);var q=V.connectedFaces[S];v.copy(this.faceNormals[q]);var z=this.getPlaneConstantOfFace(q);y.copy(v).applyQuaternion(i);var C=z-y.dot(e);for(this.clipFaceAgainstPlane(m,f,y,C);m.length;)m.shift();for(;f.length;)m.push(f.shift())}v.copy(this.faceNormals[w]);z=this.getPlaneConstantOfFace(w);y.copy(v).applyQuaternion(i);for(C=z-y.dot(e),B=0;B<m.length;B++){var P=y.dot(m[B])+C;if(P<=s&&(console.log(`clamped: depth = ${P} to minDist = ${s}`),P=s),P<=n){var T=m[B];if(P<=0){var R={point:T,normal:y,depth:P};a.push(R)}}}}}clipFaceAgainstPlane(t,e,i,r){var s,n,a=t.length;if(a<2)return e;var l=t[t.length-1],c=t[0];s=i.dot(l)+r;for(var h=0;h<a;h++){if(c=t[h],n=i.dot(c)+r,s<0)if(n<0){var u=(new o.Vector3).copy(c);e.push(u)}else{u=new o.Vector3;l.lerp(c,u,s/(s-n)),e.push(u)}else if(n<0){u=new o.Vector3;l.lerp(c,u,s/(s-n)),e.push(u),e.push(c)}l=c,s=n}return e}computeWorldVertices(t,e){for(var i=this.verticesLength;this.worldVertices.length<i;)this.worldVertices.push(new o.Vector3);for(var r=this.worldVertices,s=0;s<i;s++)r[s].copy(this.getVertex(s)).applyRotationPosition(e,t);this.worldVerticesNeedsUpdate=!1}computeLocalAABB(t,e){t.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),e.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var i=0;i<this.verticesLength;i++){var o=this.getVertex(i);o.x<t.x?t.x=o.x:o.x>e.x&&(e.x=o.x),o.y<t.y?t.y=o.y:o.y>e.y&&(e.y=o.y),o.z<t.z?t.z=o.z:o.z>e.z&&(e.z=o.z)}}computeWorldFaceNormals(t){for(var e=this.faceNormals.length;this.worldFaceNormals.length<e;)this.worldFaceNormals.push(new o.Vector3);this.faceNormals;for(var i=this.worldFaceNormals,r=0;r!==e;r++)i[r].copy(normal[r]).applyQuaternion(t);this.worldFaceNormalsNeedsUpdate=!1}updateBoundingSphereRadius(){for(var t=0,e=(this.vertices,0),i=this.verticesLength;e<i;e++){var o=this.getVertex(e).lengthSq();o>t&&(t=o)}this.boundingSphereRadius=Math.sqrt(t)}calculateWorldAABB(t,e,i,r){for(var s,n,a,l,c,h,u=new o.Vector3,p=this.verticesLength,d=0;d<p;d++){u.copy(this.getVertex(d)).applyQuaternion(e),u.addVectors(t,u);var v=u;v.x<s||void 0===s?s=v.x:(v.x>l||void 0===l)&&(l=v.x),v.y<n||void 0===n?n=v.y:(v.y>c||void 0===c)&&(c=v.y),v.z<a||void 0===a?a=v.z:(v.z>h||void 0===h)&&(h=v.z)}i.set(s,n,a),r.set(l,c,h)}volume(){return 4*Math.PI*this.boundingSphereRadius/3}getAveragePointLocal(t){t=t||new o.Vector3;for(var e=this.verticesLength,i=0;i<e;i++)t.addVectors(this.getVertex(i),t).divideScalar(e);return t}transformAllPoints(t,e){var i=this.verticesLength;this.vertices;if(e){for(var o=0;o<i;o++){var r=this.getVertex(o).applyQuaternion(e);this.setVertex(o,r)}for(o=0;o<this.faceNormals.length;o++)this.faceNormals[o].applyQuaternion(e)}if(t)for(o=0;o<i;o++){r=this.getVertex(o).addVectors(t,r);this.setVertex(o,r)}}pointIsInside(t){var e=this.verticesLength,i=(this.vertices,this.faces,this.faceNormals),r=this.facesLength,s=new o.Vector3;this.getAveragePointLocal(s);for(var n=0;n<r;n++){this.getFace(n).length,e=i[n];var a=this.getVertex(this.getFace(n)[0]),l=(new o.Vector3).subVectors(t,a),c=e.dot(l),h=(new o.Vector3).subVectors(s,a),u=e.dot(h);if(c<0&&u>0||c>0&&u<0)return!1}return-1}}l.project=function(t,e,i,s,n){var a=t.verticesLength,l=(new o.Vector3,new o.Vector3),c=0,h=0,u=new o.Vector3,p=t.vertices;r.vectorToLocalFrame(i,s,e,l),r.pointToLocalFrame(i,s,u,u);var d=u.dot(l);h=c=p[0].dot(l);for(var v=1;v<a;v++){var y=p[v].dot(l);y>c&&(c=y),y<h&&(h=y)}if((h-=d)>(c-=d)){var m=h;h=c,c=m}n[0]=c,n[1]=h};class h extends n{constructor(t){super({type:n.types.BOX}),this.halfExtents=t,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}updateConvexPolyhedronRepresentation(){var t=this.halfExtents.x,e=this.halfExtents.y,i=this.halfExtents.z,r=o.Vector3,s=[new r(-t,-e,-i),new r(t,-e,-i),new r(t,e,-i),new r(-t,e,-i),new r(-t,-e,i),new r(t,-e,i),new r(t,e,i),new r(-t,e,i)],n=(new r(0,0,1),new r(0,1,0),new r(1,0,0),new l(s,[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]]));this.convexPolyhedronRepresentation=n,n.material=this.material}calculateLocalInertia(t,e){return e=e||new o.Vector3,h.calculateInertia(this.halfExtents,t,e),e}getSideNormals(t,e){var i=t,o=this.halfExtents;if(i[0].set(o.x,0,0),i[1].set(0,o.y,0),i[2].set(0,0,o.z),i[3].set(-o.x,0,0),i[4].set(0,-o.y,0),i[5].set(0,0,-o.z),void 0!==e)for(var r=0;r!==i.length;r++)e.vmult(i[r],i[r]);return i}volume(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z}updateBoundingSphereRadius(){this.boundingSphereRadius=this.halfExtents.norm()}forEachWorldCorner(t,e,i){for(var r=new o.Vector3,s=(new o.Vector3,this.halfExtents),n=[[s.x,s.y,s.z],[-s.x,s.y,s.z],[-s.x,-s.y,s.z],[-s.x,-s.y,-s.z],[s.x,-s.y,-s.z],[s.x,s.y,-s.z],[-s.x,s.y,-s.z],[s.x,-s.y,s.z]],a=0;a<n.length;a++)r.set(n[a][0],n[a][1],n[a][2]),e.vmult(r,r),t.vadd(r,r),i(r.x,r.y,r.z)}calculateWorldAABB(t,e,i,r){var s=[new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3],n=this.halfExtents;s[0].set(n.x,n.y,n.z),s[1].set(-n.x,n.y,n.z),s[2].set(-n.x,-n.y,n.z),s[3].set(-n.x,-n.y,-n.z),s[4].set(n.x,-n.y,-n.z),s[5].set(n.x,n.y,-n.z),s[6].set(-n.x,n.y,-n.z),s[7].set(n.x,-n.y,n.z);var a=s[0];e.vmult(a,a),t.vadd(a,a),r.copy(a),i.copy(a);for(var l=1;l<8;l++){a=s[l];e.vmult(a,a),t.vadd(a,a);var c=a.x,h=a.y,u=a.z;c>r.x&&(r.x=c),h>r.y&&(r.y=h),u>r.z&&(r.z=u),c<i.x&&(i.x=c),h<i.y&&(i.y=h),u<i.z&&(i.z=u)}}}h.calculateInertia=function(t,e,i){var o=t;i.x=1/12*e*(2*o.y*2*o.y+2*o.z*2*o.z),i.y=1/12*e*(2*o.x*2*o.x+2*o.z*2*o.z),i.z=1/12*e*(2*o.y*2*o.y+2*o.x*2*o.x)};class u extends n{constructor(){super({type:n.types.PLANE}),this.worldNormal=new o.Vector3,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}computeWorldNormal(t){this.worldNormal.set(0,1,0).applyQuaternion(t),this.worldNormalNeedsUpdate=!1}calculateLocalInertia(t,e){return e=e||new o.Vector3}volume(){return Number.MAX_VALUE}calculateWorldAABB(t,e,i,r){var s=new o.Vector3;s.set(0,1,0).applyQuaternion(e);var n=Number.MAX_VALUE;i.set(-n,-n,-n),r.set(n,n,n),1===s.x&&(r.x=t.x),1===s.y&&(r.y=t.y),1===s.z&&(r.z=t.z),-1===s.x&&(i.x=t.x),-1===s.y&&(i.y=t.y),-1===s.z&&(i.z=t.z)}updateBoundingSphereRadius(){this.boundingSphereRadius=Number.MAX_VALUE}}class p extends l{constructor(t,e,i,r){t=null==t||t<1e-6?1:t,e=null==e||e<1e-6?1:e,i=null==i||i<1e-6?1:i,r=null==r||r<1e-6?3:r,console.log(t,e,i,r);var s=r,a=[],l=[],c=[],h=[],u=[],p=Math.cos,d=Math.sin;a.push(new o.Vector3(e*p(0),e*d(0),.5*-i)),h.push(0),a.push(new o.Vector3(t*p(0),t*d(0),.5*i)),u.push(1);for(var v=0;v<s;v++){var y=2*Math.PI/s*(v+1),m=2*Math.PI/s*(v+.5);v<s-1?(a.push(new o.Vector3(e*p(y),e*d(y),.5*-i)),h.push(2*v+2),a.push(new o.Vector3(t*p(y),t*d(y),.5*i)),u.push(2*v+3),c.push([2*v+2,2*v+3,2*v+1,2*v])):c.push([0,1,2*v+1,2*v]),(s%2==1||v<s/2)&&l.push(new o.Vector3(p(m),d(m),0))}c.push(u),l.push(new o.Vector3(0,0,1));var f=[];for(v=0;v<h.length;v++)f.push(h[h.length-v-1]);c.push(f),console.log(a,c,l),super(a,c,l),this.type=n.types.CYLINDER}}class d extends n{constructor(t){if(super({type:n.types.SPHERE}),this.radius=t||1,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}calculateLocalInertia(t,e){e=e||new o.Vector3;var i=2*t*this.radius*this.radius/5;return e.x=e.y=e.z=i,e}volume(){return 4*Math.PI*this.radius/3}updateBoundingSphereRadius(){this.boundingSphereRadius=this.radius}calculateWorldAABB(t,e,i,o){for(var r=this.radius,s=["x","y","z"],n=0;n<s.length;n++){var a=s[n];i[a]=t[a]-r,o[a]=t[a]+r}}}class v{constructor(){}addEventListener(t,e){void 0===this._listeners&&(this._listeners={});var i=this._listeners;return void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e),this}hasEventListener(t,e){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)}hasAnyEventListener(t){return void 0!==this._listeners&&void 0!==this._listeners[t]}removeEventListener(t,e){if(void 0===this._listeners)return this;var i=this._listeners;if(void 0===i[t])return this;var o=i[t].indexOf(e);return-1!==o&&i[t].splice(o,1),this}dispatchEvent(t){if(void 0===this._listeners)return this;var e=this._listeners[t.type];if(void 0!==e){t.target=this;for(var i=0,o=e.length;i<o;i++)e[i].call(this,t)}return this}}class y{constructor(t){var e="";"string"==typeof(t=t||{})?(e=t,t={}):"object"==typeof t&&(e=`material_${1*new Date}`),this.name=e,this.id=y.idCounter++,this.friction=void 0!==t.friction?t.friction:-1,this.restitution=void 0!==t.restitution?t.restitution:-1}}y.idCounter=0;var m={defaults:function(t,e){for(var i in t=t||{},e)i in t||(t[i]=e[i]);return t}};class f{constructor(t){t=t||{},this.lowerBound=t.lowerBound?(new o.Vector3).copy(t.lowerBound):new o.Vector3,this.upperBound=t.upperBound?(new o.Vector3).copy(t.upperBound):new o.Vector3}setFromPoints(t,e,i,r){var s=this.lowerBound,n=this.upperBound,a=i,l=new o.Vector3;s.copy(t[0]),a&&s.applyQuaternion(a),n.copy(s);for(var c=1;c<t.length;c++){var h=t[c];a&&(l.copy(h).applyQuaternion(a),h=l),h.x>n.x&&(n.x=h.x),h.x<s.x&&(s.x=h.x),h.y>n.y&&(n.y=h.y),h.y<s.y&&(s.y=h.y),h.z>n.z&&(n.z=h.z),h.z<s.z&&(s.z=h.z)}return e&&(s.addVectors(e,s),n.addVectors(e,n)),r&&(s.x-=r,s.y-=r,s.z-=r,n.x+=r,n.y+=r,n.z+=r),this}copy(t){return this.lowerBound.copy(t.lowerBound),this.upperBound.copy(t.upperBound),this}clone(){return(new f).copy(this)}extend(t){this.lowerBound.x=Math.min(this.lowerBound.x,t.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,t.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,t.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,t.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,t.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,t.upperBound.z)}overlaps(t){var e=this.lowerBound,i=this.upperBound,o=t.lowerBound,r=t.upperBound,s=o.x<=i.x&&i.x<=r.x||e.x<=r.x&&r.x<=i.x,n=o.y<=i.y&&i.y<=r.y||e.y<=r.y&&r.y<=i.y,a=o.z<=i.z&&i.z<=r.z||e.z<=r.z&&r.z<=i.z;return s&&n&&a}volume(){var t=this.lowerBound,e=this.upperBound;return(e.x-t.x)*(e.y-t.y)*(e.z-t.z)}contains(t){var e=this.lowerBound,i=this.upperBound,o=t.lowerBound,r=t.upperBound;return e.x<=o.x&&i.x>=r.x&&e.y<=o.y&&i.y>=r.y&&e.z<=o.z&&i.z>=r.z}getCorners(t,e,i,o,r,s,n,a){var l=this.lowerBound,c=this.upperBound;t.copy(l),e.set(c.x,l.y,l.z),i.set(c.x,c.y,l.z),o.set(l.x,c.y,c.z),r.set(c.x,l.y,l.z),s.set(l.x,c.y,l.z),n.set(l.x,l.y,c.z),a.copy(c)}toLocalFrame(t,e){var i=[new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3],r=i[0],s=i[1],n=i[2],a=i[3],l=i[4],c=i[5],h=i[6],u=i[7];this.getCorners(r,s,n,a,l,c,h,u);for(var p=0;8!==p;p++){var d=i[p];t.pointToLocal(d,d)}return e.setFromPoints(i)}toWorldFrame(t,e){var i=[new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3],r=i[0],s=i[1],n=i[2],a=i[3],l=i[4],c=i[5],h=i[6],u=i[7];this.getCorners(r,s,n,a,l,c,h,u);for(var p=0;p<8;p++){var d=i[p];t.pointToWorld(d,d)}return e.setFromPoints(i)}overlapsRay(t){var e=1/t._direction.x,i=1/t._direction.y,o=1/t._direction.z,r=(this.lowerBound.x-t.from.x)*e,s=(this.upperBound.x-t.from.x)*e,n=(this.lowerBound.y-t.from.y)*i,a=(this.upperBound.y-t.from.y)*i,l=(this.lowerBound.z-t.from.z)*o,c=(this.upperBound.z-t.from.z)*o,h=Math.max(Math.max(Math.min(r,s),Math.min(n,a)),Math.min(l,c)),u=Math.min(Math.min(Math.max(r,s),Math.max(n,a)),Math.max(l,c));return!(u<0)&&!(h>u)}}class w extends v{constructor(t){t=t||{},super(),this.id=w.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new o.Vector3,this.collisionFilterGroup="number"==typeof t.collisionFilterGroup?t.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionResponse=!0,this.position=t.position?(new o.Vector3).copy(t.position):new o.Vector3,this.previousPosition=t.position?(new o.Vector3).copy(t.position):new o.Vector3,this.interpolatedPosition=t.position?(new o.Vector3).copy(t.position):new o.Vector3,this.initPosition=t.position?(new o.Vector3).copy(t.position):new o.Vector3,this.velocity=t.velocity?(new o.Vector3).copy(t.velocity):new o.Vector3,this.initVelocity=new o.Vector3,this.force=new o.Vector3;var e="number"==typeof t.mass?t.mass:0;this.mass=e,this.invMass=e>0?1/e:0,this.material=t.material||null,this.linearDamping="number"==typeof t.linearDamping?t.linearDamping:.01,this.type=e<=0?w.STATIC:w.DYNAMIC,typeof t.type==typeof w.STATIC&&(this.type=t.type),this.allowSleep=void 0===t.allowSleep||t.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==t.sleepSpeedLimit?t.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==t.sleepTimeLimit?t.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new o.Vector3,this.quaternion=t.quaternion?(new o.Quaternion).copy(t.quaternion):new o.Quaternion,this.initQuaternion=t.quaternion?(new o.Quaternion).copy(t.quaternion):new o.Quaternion,this.previousQuaternion=t.quaternion?(new o.Quaternion).copy(t.quaternion):new o.Quaternion,this.interpolatedQuaternion=t.quaternion?(new o.Quaternion).copy(t.quaternion):new o.Quaternion,this.angularVelocity=t.angularVelocity?(new o.Vector3).copy(t.angularVelocity):new o.Vector3,this.initAngularVelocity=new o.Vector3,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new o.Vector3,this.invInertia=new o.Vector3,this.invInertiaWorld=new o.Matrix3,this.invMassSolve=0,this.invInertiaSolve=new o.Vector3,this.invInertiaWorldSolve=new o.Matrix3,this.fixedRotation=void 0!==t.fixedRotation&&t.fixedRotation,this.angularDamping=void 0!==t.angularDamping?t.angularDamping:.01,this.linearFactor=t.linearFactor?(new o.Vector3).copy(t.linearFactor):new o.Vector3(1,1,1),this.angularFactor=t.angularFactor?(new o.Vector3).copy(t.angularFactor):new o.Vector3(1,1,1),this.aabb=new f,this.aabbNeedsUpdate=!0,this.boundingRadius=0,this.wlambda=new o.Vector3,!t.shape||this.addShape(t.shape),this.updateMassProperties()}wakeUp(){var t=this.sleepState;this.sleepState=0,this._wakeUpAfterNarrowphase=!1,t===w.SLEEPING&&this.dispatchEvent(w.wakeupEvent)}sleep(){this.sleepState=w.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this._wakeUpAfterNarrowphase=!1}sleepTick(t){if(this.allowSleep){var e=this.sleepState,i=this.velocity.lengthSq()+this.angularVelocity.lengthSq(),o=Math.pow(this.sleepSpeedLimit,2);e===w.AWAKE&&i<o?(this.sleepState=w.SLEEPY,this.timeLastSleepy=t,this.dispatchEvent(w.sleepyEvent)):e===w.SLEEPY&&i>o?this.wakeUp():e===w.SLEEPY&&t-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(w.sleepEvent))}}updateSolveMassProperties(){this.sleepState===w.SLEEPING||this.type===w.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.set(0,0,0),this.invInertiaWorldSolve.set(0,0,0,0,0,0,0,0,0)):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))}pointToLocalFrame(t,e){let i=(new o.Quaternion).copy(this.quaternion).conjugate();return(new o.Vector3).subVectors(t,this.position).applyQuaternion(i)}vectorToLocalFrame(t,e){let i=(new o.Quaternion).copy(this.quaternion).conjugate();return(new o.Vector3).copy(t).applyQuaternion(i)}pointToWorldFrame(t,e){return(e=(new o.Vector3).copy(t).applyQuaternion(this.quaternion)).subVectors(this.position,e),e}vectorToWorldFrame(t,e){return(new o.Vector3).copy(t).applyQuaternion(this.quaternion)}addShape(t,e,i){var r=e?(new o.Vector3).copy(e):new o.Vector3,s=i?(new o.Quaternion).copy(e):new o.Quaternion;return this.shapes.push(t),this.shapeOffsets.push(r),this.shapeOrientations.push(s),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,t.body=this,this}updateBoundingRadius(){for(var t=this.shapes,e=this.shapeOffsets,i=t.length,o=0,r=0;r<i;r++){var s=t[r];s.updateBoundingSphereRadius();var n=e[r].length(),a=s.boundingSphereRadius;n+a>o&&(o=n+a)}this.boundingRadius=o}computeAABB(){for(var t=this.shapes,e=this.shapeOffsets,i=this.shapeOrientations,r=t.length,s=new o.Vector3,n=new o.Quaternion,a=this.quaternion,l=this.aabb,c=new f,h=0;h<r;h++){var u=t[h];(s=(new o.Vector3).copy(e[h]).applyQuaternion(a)).addVectors(this.position,s),n.multiplyQuaternions(i[h],a),u.calculateWorldAABB(s,n,c.lowerBound,c.upperBound),0===h?l.copy(c):l.extend(c)}this.aabbNeedsUpdate=!1}updateInertiaWorld(t){var e=this.invInertia;if(e.x!==e.y||e.y!==e.z||t){var i=new o.Matrix3,s=new o.Matrix3;r.setRotationFromQuaternion(i,this.quaternion),s.copy(i).transpose(),function(t,e){for(var i=(e=e||new o.Matrix3).elements,r=0;3!==r;r++)i[3*r+0]=t.x*i[3*r+0],i[3*r+1]=t.y*i[3*r+1],i[3*r+2]=t.z*i[3*r+2]}(e,i),this.invInertiaWorld.multiplyMatrices(i,s)}else;}applyForce(t,e){if(this.type!==w.DYNAMIC)return;let i=(new o.Vector3).crossVectors(e,t);this.force.addVectors(t,this.force),this.torque.addVectors(i,this.torque)}applyLocalForce(t,e){if(this.type===w.DYNAMIC){var i=new o.Vector3,r=new o.Vector3;this.vectorToWorldFrame(t,i),this.vectorToWorldFrame(e,r),this.applyForce(i,r)}}applyImpulse(t,e){if(this.type===w.DYNAMIC){var i=e,r=(new o.Vector3).copy(t);r.multiplyScalar(this.invMass),this.velocity.addVectors(r,this.velocity);var s=(new o.Vector3).crossVectors(i,t).applyMatrix3(this.invInertiaWorld);this.angularVelocity.addVectors(s,this.angularVelocity)}}applyLocalImpulse(t,e){if(this.type===w.DYNAMIC){var i=new o.Vector3,r=new o.Vector3;this.vectorToWorldFrame(t,i),this.vectorToWorldFrame(e,r),this.applyImpulse(i,r)}}updateMassProperties(){var t=new o.Vector3;this.invMass=this.mass>0?1/this.mass:0;var e=this.inertia,i=this.fixedRotation;this.computeAABB(),t.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),h.calculateInertia(t,this.mass,e),this.invInertia.set(e.x>0&&!i?1/e.x:0,e.y>0&&!i?1/e.y:0,e.z>0&&!i?1/e.z:0),this.updateInertiaWorld(!0)}getVelocityAtWorldPoint(t,e){var i=(new o.Vector3).subVectors(t,this.position);return e.crossVectors(this.angularVelocity,i),e.addVectors(this.velocity,e),e}integrate(t,e,i){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),(this.type===w.DYNAMIC||this.type===w.KINEMATIC)&&this.sleepState!==w.SLEEPING){var r=this.velocity,s=this.angularVelocity,n=this.position,a=this.force,l=new o.Vector3,c=this.quaternion,h=this.invMass,u=this.invInertiaWorld,p=this.linearFactor,d=h*t;r.x+=a.x*d*p.x,r.y+=a.y*d*p.y,r.z+=a.z*d*p.z;var v=u.elements,y=this.angularFactor,m=l.x*y.x,f=l.y*y.y,b=l.z*y.z;s.x+=t*(v[0]*m+v[1]*f+v[2]*b),s.y+=t*(v[3]*m+v[4]*f+v[5]*b),s.z+=t*(v[6]*m+v[7]*f+v[8]*b),n.x+=r.x*t,n.y+=r.y*t,n.z+=r.z*t,c.integrate(this.angularVelocity,t,this.angularFactor,c),e&&(i?c.normalizeFast():c.normalize()),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}}}w.COLLIDE_EVENT_NAME="collide",w.DYNAMIC=1,w.STATIC=2,w.KINEMATIC=4,w.AWAKE=0,w.SLEEPY=1,w.SLEEPING=2,w.idCounter=0,w.wakeupEvent={type:"wakeup"},w.sleepyEvent={type:"sleepy"},w.sleepEvent={type:"sleep"};class g{constructor(t,e,i){i=i||{},this.restLength="number"==typeof i.restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=t,this.bodyB=e,this.localAnchorA=new o.Vector3,this.localAnchorB=new o.Vector3,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}setWorldAnchorA(t){this.bodyA.pointToLocalFrame(t,this.localAnchorA)}setWorldAnchorB(t){this.bodyB.pointToLocalFrame(t,this.localAnchorB)}getWorldAnchorA(t){this.bodyA.pointToWorldFrame(this.localAnchorA,t)}getWorldAnchorB(t){this.bodyB.pointToWorldFrame(this.localAnchorB,t)}applyForce(){var t=new o.Vector3,e=new o.Vector3,i=new o.Vector3,r=new o.Vector3,s=new o.Vector3,n=new o.Vector3,a=new o.Vector3,l=new o.Vector3,c=new o.Vector3,h=new o.Vector3,u=new o.Vector3,p=this.stiffness,d=this.damping,v=this.restLength,y=this.bodyA,m=this.bodyB,f=t,w=e,b=i,g=r,x=u,V=s,B=n,E=a,A=l,S=c,F=h;this.getWorldAnchorA(V),this.getWorldAnchorB(B),V.vsub(y.position,E),B.vsub(m.position,A),B.vsub(V,f);var M=f.norm();w.copy(f),w.normalize(),m.velocity.vsub(y.velocity,b),m.angularVelocity.cross(A,x),b.vadd(x,b),y.angularVelocity.cross(E,x),b.vsub(x,b),w.mult(-p*(M-v)-d*b.dot(w),g),y.force.vsub(g,y.force),m.force.vadd(g,m.force),E.cross(g,S),A.cross(g,F),y.torque.vsub(S,y.torque),m.torque.vadd(F,m.torque)}}class x{constructor(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}add(t){this.particles.push(t),this.neighbors.length<this.particles.length&&this.neighbors.push([])}remove(t){var e=this.particles.indexOf(t);-1!==e&&(this.particles.splice(e,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())}getNeighbors(t,e){for(var i=this.particles.length,r=t.id,s=this.smoothingRadius*this.smoothingRadius,n=new o.Vector3,a=0;a!==i;a++){var l=this.particles[a];l.position.vsub(t.position,n),r!==l.id&&n.norm2()<s&&e.push(l)}}update(){for(var t=new o.Vector3,e=new o.Vector3,i=new o.Vector3,r=new o.Vector3,s=new o.Vector3,n=new o.Vector3,a=this.particles.length,l=t,c=this.speedOfSound,h=this.eps,u=0;u!==a;u++){var p=this.particles[u];(S=this.neighbors[u]).length=0,this.getNeighbors(p,S),S.push(this.particles[u]);for(var d=S.length,v=0,y=0;y!==d;y++){p.position.vsub(S[y].position,l);var m=l.norm(),f=this.w(m);v+=S[y].mass*f}this.densities[u]=v,this.pressures[u]=c*c*(this.densities[u]-this.density)}var w=e,b=i,g=r,x=s,V=n;for(u=0;u!==a;u++){var B,E,A=this.particles[u];w.set(0,0,0),b.set(0,0,0);var S;for(d=(S=this.neighbors[u]).length,y=0;y!==d;y++){var F=S[y];A.position.vsub(F.position,x);var M=x.norm();B=-F.mass*(this.pressures[u]/(this.densities[u]*this.densities[u]+h)+this.pressures[y]/(this.densities[y]*this.densities[y]+h)),this.gradw(x,g),g.mult(B,g),w.vadd(g,w),F.velocity.vsub(A.velocity,V),V.mult(1/(1e-4+this.densities[u]*this.densities[y])*this.viscosity*F.mass,V),E=this.nablaw(M),V.mult(E,V),b.vadd(V,b)}b.mult(A.mass,b),w.mult(A.mass,w),A.force.vadd(b,A.force),A.force.vadd(w,A.force)}}w(t){var e=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(e,9))*Math.pow(e*e-t*t,3)}gradw(t,e){var i=t.norm(),o=this.smoothingRadius;t.mult(945/(32*Math.PI*Math.pow(o,9))*Math.pow(o*o-i*i,2),e)}nablaw(t){var e=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(e,9))*(e*e-t*t)*(7*t*t-3*e*e)}}class V{constructor(t){t=t||{},this.root=t.root||null,this.aabb=t.aabb?t.aabb.clone():new f,this.data=[],this.children=[]}}class B extends V{constructor(t,e){(e=e||{}).root=null,e.aabb=t,V.call(this,e),this.maxDepth=void 0!==e.maxDepth?e.maxDepth:8}reset(t,e){this.children.length=this.data.length=0}insert(t,e,i){var o=this.data;if(i=i||0,!this.aabb.contains(t))return!1;var r=this.children;if(i<(this.maxDepth||this.root.maxDepth)){var s=!1;r.length||(this.subdivide(),s=!0);for(var n=0;8!==n;n++)if(r[n].insert(t,e,i+1))return!0;s&&(r.length=0)}return o.push(e),!0}subdivide(){var t=new o.Vector3,e=this.aabb,i=e.lowerBound,r=e.upperBound,s=this.children;s.push(new V({aabb:new f({lowerBound:new o.Vector3(0,0,0)})}),new V({aabb:new f({lowerBound:new o.Vector3(1,0,0)})}),new V({aabb:new f({lowerBound:new o.Vector3(1,1,0)})}),new V({aabb:new f({lowerBound:new o.Vector3(1,1,1)})}),new V({aabb:new f({lowerBound:new o.Vector3(0,1,1)})}),new V({aabb:new f({lowerBound:new o.Vector3(0,0,1)})}),new V({aabb:new f({lowerBound:new o.Vector3(1,0,1)})}),new V({aabb:new f({lowerBound:new o.Vector3(0,1,0)})})),r.vsub(i,t),t.scale(.5,t);for(var n=this.root||this,a=0;8!==a;a++){var l=s[a];l.root=n;var c=l.aabb.lowerBound;c.x*=t.x,c.y*=t.y,c.z*=t.z,c.vadd(i,c),c.vadd(t,l.aabb.upperBound)}}aabbQuery(t,e){this.data,this.children;for(var i=[this];i.length;){var o=i.pop();o.aabb.overlaps(t)&&Array.prototype.push.apply(e,o.data),Array.prototype.push.apply(i,o.children)}return e}rayQuery(t,e,i){var o=new f;return t.getAABB(o),o.toLocalFrame(e,o),this.aabbQuery(o,i),i}removeEmptyNodes(){for(var t=[this];t.length;){for(var e=t.pop(),i=e.children.length-1;i>=0;i--)e.children[i].data.length||e.children.splice(i,1);Array.prototype.push.apply(t,e.children)}}}class E{constructor(){this.objects=[],this.type=Object}release(){for(var t=0;t<arguments.length;t++)this.objects.push(arguments[t]);return this}get(){return 0===this.objects.length?this.constructObject():this.objects.pop()}constructObject(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}resize(t){for(var e=this.objects;e.length>t;)e.pop();for(;e.length<t;)e.push(this.constructObject());return this}}class A{constructor(){this.data={keys:[]}}get(t,e){if(t>e){var i=e;e=t,t=i}return this.data[t+"-"+e]}set(t,e,i){if(t>e){var o=e;e=t,t=o}var r=t+"-"+e;this.get(t,e)||this.data.keys.push(r),this.data[r]=i}reset(){for(var t=this.data,e=t.keys;e.length>0;){delete t[e.pop()]}}}class S extends E{constructor(){super(),this.type=o.Vector3}constructObject(){return new o.Vector3}}class F{constructor(t,e,i){i=m.defaults(i,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=F.idCounter++,this.materials=[t,e],this.friction=i.friction,this.restitution=i.restitution,this.contactEquationStiffness=i.contactEquationStiffness,this.contactEquationRelaxation=i.contactEquationRelaxation,this.frictionEquationStiffness=i.frictionEquationStiffness,this.frictionEquationRelaxation=i.frictionEquationRelaxation}}F.idCounter=0;class M{constructor(t,e,i,o){this.id=M.id++,this.minForce=void 0===i?-1e6:i,this.maxForce=void 0===o?1e6:o,this.bi=t,this.bj=e,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new s,this.jacobianElementB=new s,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}setSpookParams(t,e,i){var o=e,r=t,s=i;this.a=4/(s*(1+4*o)),this.b=4*o/(1+4*o),this.eps=4/(s*s*r*(1+4*o))}computeB(t,e,i){var o=this.computeGW();return-this.computeGq()*t-o*e-this.computeGiMf()*i}computeGq(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,o=this.bj,r=i.position,s=o.position;return t.spatial.dot(r)+e.spatial.dot(s)}computeGW(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,o=this.bj,r=i.velocity,s=o.velocity,n=i.angularVelocity,a=o.angularVelocity;return t.multiplyVectors(r,n)+e.multiplyVectors(s,a)}computeGWlambda(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,o=this.bj,r=i.vlambda,s=o.vlambda,n=i.wlambda,a=o.wlambda;return t.multiplyVectors(r,n)+e.multiplyVectors(s,a)}computeGiMf(){var t=new o.Vector3,e=new o.Vector3,i=new o.Vector3,r=new o.Vector3,s=this.jacobianElementA,n=this.jacobianElementB,a=this.bi,l=this.bj,c=a.force,h=a.torque,u=l.force,p=l.torque,d=a.invMassSolve,v=l.invMassSolve;return t.copy(c).multiplyScalar(d),e.copy(u).multiplyScalar(v),i.copy(h).applyMatrix3(a.invInertiaWorldSolve),r.copy(p).applyMatrix3(l.invInertiaWorldSolve),s.multiplyVectors(t,i)+n.multiplyVectors(e,r)}computeGiMGt(){var t=new o.Vector3,e=this.jacobianElementA,i=this.jacobianElementB,r=this.bi,s=this.bj,n=r.invMassSolve,a=s.invMassSolve,l=r.invInertiaWorldSolve,c=s.invInertiaWorldSolve,h=n+a;return t.copy(e.rotational).applyMatrix3(l),h+=t.dot(e.rotational),t.copy(i.rotational).applyMatrix3(c),h+=t.dot(i.rotational)}addToWlambda(t){var e=this.jacobianElementA,i=this.jacobianElementB,r=this.bi,s=this.bj,n=new o.Vector3;n.copy(e.spatial).multiplyScalar(r.invMassSolve*t),r.vlambda.addVectors(n,r.vlambda),n.copy(i.spatial).multiplyScalar(s.invMassSolve*t),s.vlambda.addVectors(n,s.vlambda),n.copy(e.rotational).applyMatrix3(r.invInertiaWorldSolve).multiplyScalar(t),r.wlambda.addVectors(r.wlambda,n),n.copy(i.rotational).applyMatrix3(s.invInertiaWorldSolve).multiplyScalar(t),s.wlambda.addVectors(s.wlambda,n)}computeC(){return this.computeGiMGt()+this.eps}}M.id=0;class q extends M{constructor(t,e,i){var r=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;M.call(this,t,e,-r,r),this.axisA=i.axisA?i.axisA.clone():new o.Vector3(1,0,0),this.axisB=i.axisB?i.axisB.clone():new o.Vector3(0,1,0),this.maxAngle=Math.PI/2}computeB(t){var e=this.a,i=this.b,r=this.axisA,s=this.axisB,n=new o.Vector3,a=new o.Vector3,l=this.jacobianElementA,c=this.jacobianElementB;return n.crossVectors(r,s),a.crossVectors(s,r),l.rotational.copy(a),c.rotational.copy(n),-(Math.cos(this.maxAngle)-r.dot(s))*e-this.computeGW()*i-t*this.computeGiMf()}}class z extends M{constructor(t,e,i){var r=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;super(t,e,-r,r),this.axisA=i.axisA?i.axisA.clone():new o.Vector3(1,0,0),this.axisB=i.axisB?i.axisB.clone():new o.Vector3(0,1,0),this.angle=void 0!==i.angle?i.angle:0}computeB(t){var e=this.a,i=this.b,r=this.axisA,s=this.axisB,n=new o.Vector3,a=new o.Vector3,l=this.jacobianElementA,c=this.jacobianElementB;return n.crossVectors(r,s),a.crossVectors(s,r),l.rotational.copy(a),c.rotational.copy(n),-(Math.cos(this.angle)-r.dot(s))*e-this.computeGW()*i-t*this.computeGiMf()}}class C extends M{constructor(t,e,i){super(t,e,-i,i),this.ri=new o.Vector3,this.rj=new o.Vector3,this.t=new o.Vector3}computeB(t){this.a;var e=this.b,i=(this.bi,this.bj,this.ri),r=this.rj,s=new o.Vector3,n=new o.Vector3,a=this.t;s.crossVectors(i,a),n.crossVectors(r,a);var l=this.jacobianElementA,c=this.jacobianElementB;return a.negate(l.spatial),s.negate(l.rotational),c.spatial.copy(a),c.rotational.copy(n),-this.computeGW()*e-t*this.computeGiMf()}}class P extends M{constructor(t,e,i){i=void 0!==i?i:1e6,M.call(this,t,e,-i,i),this.axisA=new o.Vector3,this.axisB=new o.Vector3,this.targetVelocity=0}computeB(t){this.a;var e=this.b,i=(this.bi,this.bj,this.axisA),o=this.axisB,r=this.jacobianElementA,s=this.jacobianElementB;return r.rotational.copy(i),o.negate(s.rotational),-(this.computeGW()-this.targetVelocity)*e-t*this.computeGiMf()}}class T extends M{constructor(t,e,i){super(t,e,0,i=void 0!==i?i:1e6),this.restitution=0,this.ri=new o.Vector3,this.rj=new o.Vector3,this.ni=new o.Vector3}computeB(t){var e=this.a,i=this.b,r=this.bi,s=this.bj,n=this.ri,a=this.rj,l=new o.Vector3,c=new o.Vector3,h=r.velocity,u=r.angularVelocity,p=(r.force,r.torque,s.velocity),d=s.angularVelocity,v=(s.force,s.torque,new o.Vector3),y=this.jacobianElementA,m=this.jacobianElementB,f=this.ni;l.crossVectors(n,f),c.crossVectors(a,f),y.spatial.copy(f).negate(),y.rotational.copy(l).negate(),m.spatial.copy(f),m.rotational.copy(c),v.copy(s.position),v.addVectors(a,v),v.subVectors(r.position,v),v.subVectors(n,v);var w=f.dot(v),b=this.restitution+1;return-w*e-(b*p.dot(f)-b*h.dot(f)+d.dot(c)-u.dot(l))*i-t*this.computeGiMf()}getImpactVelocityAlongNormal(){var t=new o.Vector3,e=new o.Vector3,i=new o.Vector3,r=new o.Vector3,s=new o.Vector3;return i.addVectors(this.bi.position,this.ri),r.addVectors(this.bj.position,this.rj),this.bi.getVelocityAtWorldPoint(i,t),this.bj.getVelocityAtWorldPoint(r,e),s.subVectors(t,e),this.ni.dot(s)}}class R{constructor(){this.equations=[]}solve(t,e){return 0}addEquation(t){t.enabled&&this.equations.push(t)}removeEquation(t){var e=this.equations,i=e.indexOf(t);-1!==i&&e.splice(i,1)}removeAllEquations(){this.equations.length=0}}class N extends R{constructor(t){for(super(),this.iterations=10,this.tolerance=1e-7,this.subsolver=t,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}createNode(){return{body:null,children:[],eqs:[],visited:!1}}solve(t,e){for(var i=[],o=this.nodePool,r=e.bodies,s=this.equations,n=s.length,a=r.length,l=this.subsolver;o.length<a;)o.push(this.createNode());i.length=a;for(var c=0;c<a;c++)i[c]=o[c];for(c=0;c!==a;c++){var h=i[c];h.body=r[c],h.children.length=0,h.eqs.length=0,h.visited=!1}for(var u=0;u!==n;u++){var p=s[u],d=(c=r.indexOf(p.bi),r.indexOf(p.bj)),v=i[c],y=i[d];v.children.push(y),v.eqs.push(p),y.children.push(v),y.eqs.push(p)}var m,f=0,w=[];l.tolerance=this.tolerance,l.iterations=this.iterations;for(var b={bodies:[]};m=j(i);){w.length=0,b.bodies.length=0,I(m,O,b.bodies,w);var g=w.length;w=w.sort(L);for(c=0;c!==g;c++)l.addEquation(w[c]);l.solve(t,b);l.removeAllEquations(),f++}return f}}function L(t,e){return e.id-t.id}function j(t){for(var e=t.length,i=0;i!==e;i++){var o=t[i];if(!(o.visited||o.body.type&w.STATIC))return o}return!1}function I(t,e,i,o){var r=[];for(r.push(t),t.visited=!0,e(t,i,o);r.length;)for(var s,n=r.pop();s=j(n.children);)s.visited=!0,e(s,i,o),r.push(s)}function O(t,e,i){e.push(t.body);for(var o=t.eqs.length,r=0;r!==o;r++){var s=t.eqs[r];-1===i.indexOf(s)&&i.push(s)}}class W extends R{constructor(){super(),this.iterations=10,this.tolerance=1e-7}solve(t,e){var i,o,r,s,n,a=0,l=this.iterations,c=this.tolerance*this.tolerance,h=this.equations,u=h.length,p=e.bodies,d=p.length,v=t;if(0!==u)for(var y=0;y<d;y++)p[y].updateSolveMassProperties();var m=[],f=[],w=[];m.length=u,f.length=u,w.length=u;for(y=0;y<u;y++){var b=h[y];w[y]=0,f[y]=b.computeB(v),m[y]=1/b.computeC()}if(0!==u){for(y=0;y<d;y++){var g=(B=p[y]).vlambda,x=B.wlambda;g.set(0,0,0),x.set(0,0,0)}for(a=0;a<l;a++){s=0;for(var V=0;V<u;V++){b=h[V];i=f[V],o=m[V],(n=w[V])+(r=o*(i-b.computeGWlambda()-b.eps*n))<b.minForce?r=b.minForce-n:n+r>b.maxForce&&(r=b.maxForce-n),w[V]+=r,s+=r>0?r:-r,b.addToWlambda(r)}if(s*s<c)break}for(y=0;y<d;y++){var B,E=(B=p[y]).velocity,A=B.angularVelocity;B.vlambda.multiplyVectors(B.vlambda,B.linearFactor),E.addVectors(B.vlambda,E),B.wlambda.multiplyVectors(B.wlambda,B.angularFactor),A.addVectors(B.wlambda,A)}for(var S=h.length,F=1/v;S--;)h[S].multiplier=w[S]*F}return a}}class k{constructor(){this.rayFromWorld=new o.Vector3,this.rayToWorld=new o.Vector3,this.hitNormalWorld=new o.Vector3,this.hitPointWorld=new o.Vector3,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}reset(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}abort(){this._shouldStop=!0}set(t,e,i,o,r,s,n){this.rayFromWorld.copy(t),this.rayToWorld.copy(e),this.hitNormalWorld.copy(i),this.hitPointWorld.copy(o),this.shape=r,this.body=s,this.distance=n}}class _{constructor(){this.current=[],this.previous=[]}getKey(t,e){if(e<t){var i=e;e=t,t=i}return t<<16|e}set(t,e){for(var i=this.getKey(t,e),o=this.current,r=0;i>o[r];)r++;if(i!==o[r]){for(e=o.length-1;e>=r;e--)o[e+1]=o[e];o[r]=i}}tick(){var t=this.current;this.current=this.previous,this.previous=t,this.current.length=0}getDiff(t,e){function i(t,e){t.push((4294901760&e)>>16,65535&e)}for(var o=this.current,r=this.previous,s=o.length,n=r.length,a=0,l=0;l<s;l++){for(var c=o[l];c>r[a];)a++;c===r[a]||i(t,c)}a=0;for(l=0;l<n;l++){for(var h=r[l];h>o[a];)a++;o[a]===h||i(e,h)}}}class Q{constructor(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}collisionPairs(t,e,i){throw new Error("collisionPairs not implemented for this BroadPhase class!")}needBroadphaseCollision(t,e){return 0!=(t.collisionFilterGroup&e.collisionFilterMask)&&0!=(e.collisionFilterGroup&t.collisionFilterMask)&&(0==(t.type&w.STATIC)&&t.sleepState!==w.SLEEPING||0==(e.type&w.STATIC)&&e.sleepState!==w.SLEEPING)}intersectionTest(t,e,i,o){this.useBoundingBoxes?this.doBoundingBoxBroadphase(t,e,i,o):this.doBoundingSphereBroadphase(t,e,i,o)}doBoundingSphereBroadphase(t,e,i,r){var s=(new o.Vector3).subVectors(e.position,t.position),n=Math.pow(t.boundingRadius+e.boundingRadius,2);s.lengthSq()<n&&(i.push(t),r.push(e))}doBoundingBoxBroadphase(t,e,i,o){t.aabbNeedsUpdate&&t.computeAABB(),e.aabbNeedsUpdate&&e.computeAABB(),t.aabb.overlaps(e.aabb)&&(i.push(t),o.push(e))}makePairsUnique(t,e){for(var i={keys:[]},o=[],r=[],s=0;s<t.length;s++)o[s]=t[s],r[s]=e[s];t.length=e.length=0;for(s=0;s<t.length;s++){var n=o[s].id,a=r[s].id;i[l=n<a?n+","+a:a+","+n]=s,i.keys.push(l)}for(s=0;s<i.keys.length;s++){var l=i.keys.pop(),c=i[l];t.push(o[c]),e.push(r[c]),delete i[l]}}setWorld(t){}aabbQuery(t,e,i){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}}Q.boundingSphereCheck=function(t,e){var i=(new o.Vector3).subVectors(t.position,e.position);return Math.pow(t.shape.boundingSphereRadius+e.shape.boundingSphereRadius,2)>i.lengthSq()};class H extends Q{constructor(t){super(),this.axisList=[],this.world=t?this.setWorld(t):null,this.axisIndex=0;var e=this.axisList;this._addBodyHandler=function(t){e.push(t.body)},this._removeBodyHandler=function(t){var i=e.indexOf(t.body);-1!==i&&e.splice(i,1)}}setWorld(t){this.axisList.length=0;for(var e=0;e<t.bodies.length;e++)this.axisList.push(t.bodies[e]);t.removeEventListener("addBody",this._addBodyHandler),t.removeEventListener("removeBody",this._removeBodyHandler),t.addEventListener("addBody",this._addBodyHandler),t.addEventListener("removeBody",this._removeBodyHandler),this.world=t,this.dirty=!0}collisionPairs(t,e,i){var o,r,s=this.axisList,n=s.length,a=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),o=0;o!==n;o++){var l=s[o];for(r=o+1;r<n;r++){var c=s[r];if(this.needBroadphaseCollision(l,c)){if(!H.checkBounds(l,c,a))break;this.intersectionTest(l,c,e,i)}}}}sortList(){for(var t=this.axisList,e=this.axisIndex,i=t.length,o=0;o!==i;o++){var r=t[o];r.aabbNeedsUpdate&&r.computeAABB()}0===e?H.insertionSortX(t):1===e?H.insertionSortY(t):2===e&&H.insertionSortZ(t)}autoDetectAxis(){for(var t=0,e=0,i=0,o=0,r=0,s=0,n=this.axisList,a=n.length,l=1/a,c=0;c!==a;c++){var h=n[c],u=h.position.x;t+=u,e+=u*u;var p=h.position.y;i+=p,o+=p*p;var d=h.position.z;r+=d,s+=d*d}var v=e-t*t*l,y=o-i*i*l,m=s-r*r*l;this.axisIndex=v>y?v>m?0:2:y>m?1:2}aabbQuery(t,e,i){i=i||[],this.dirty&&(this.sortList(),this.dirty=!1);var o=this.axisIndex,r="x";1===o&&(r="y"),2===o&&(r="z");for(var s=this.axisList,n=(e.lowerBound[r],e.upperBound[r],0);n<s.length;n++){var a=s[n];a.aabbNeedsUpdate&&a.computeAABB(),a.aabb.overlaps(e)&&i.push(a)}return i}}H.insertionSortX=function(t){for(var e=1,i=t.length;e<i;e++){for(var o=t[e],r=e-1;r>=0&&!(t[r].aabb.lowerBound.x<=o.aabb.lowerBound.x);r--)t[r+1]=t[r];t[r+1]=o}return t},H.insertionSortY=function(t){for(var e=1,i=t.length;e<i;e++){for(var o=t[e],r=e-1;r>=0&&!(t[r].aabb.lowerBound.y<=o.aabb.lowerBound.y);r--)t[r+1]=t[r];t[r+1]=o}return t},H.insertionSortZ=function(t){for(var e=1,i=t.length;e<i;e++){for(var o=t[e],r=e-1;r>=0&&!(t[r].aabb.lowerBound.z<=o.aabb.lowerBound.z);r--)t[r+1]=t[r];t[r+1]=o}return t},H.checkBounds=function(t,e,i){var o,r;0===i?(o=t.position.x,r=e.position.x):1===i?(o=t.position.y,r=e.position.y):2===i&&(o=t.position.z,r=e.position.z);var s=t.boundingRadius,n=e.boundingRadius;return r-n<o+s};class D extends Q{constructor(t,e,i,o,r){super(),this.nx=i||10,this.ny=o||10,this.nz=r||10,this.aabbMin=t||new Vec3(100,100,100),this.aabbMax=e||new Vec3(-100,-100,-100);var s=this.nx*this.ny*this.nz;if(s<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=s,this.binLengths.length=s;for(var n=0;n<s;n++)this.bins[n]=[],this.binLengths[n]=0}collisionPairs(t,e,i){for(var r=t.numObjects(),s=t.bodies,a=this.aabbMax,l=this.aabbMin,c=this.nx,h=this.ny,u=this.nz,p=h*u,d=u,v=1,y=a.x,m=a.y,f=a.z,w=l.x,b=l.y,g=l.z,x=c/(y-w),V=h/(m-b),B=u/(f-g),E=(y-w)/c,A=(m-b)/h,S=(f-g)/u,F=.5*Math.sqrt(E*E+A*A+S*S),M=n.types,q=M.SPHERE,z=M.PLANE,C=(M.BOX,M.COMPOUND,M.CONVEXPOLYHEDRON,this.bins),P=this.binLengths,T=this.bins.length,R=0;R!==T;R++)P[R]=0;var N=Math.ceil;l=Math.min,a=Math.max;function L(t,e,i,o,r,s,n){var a=(t-w)*x|0,l=(e-b)*V|0,y=(i-g)*B|0,m=N((o-w)*x),f=N((r-b)*V),E=N((s-g)*B);a<0?a=0:a>=c&&(a=c-1),l<0?l=0:l>=h&&(l=h-1),y<0?y=0:y>=u&&(y=u-1),m<0?m=0:m>=c&&(m=c-1),f<0?f=0:f>=h&&(f=h-1),E<0?E=0:E>=u&&(E=u-1),l*=d,y*=v,m*=p,f*=d,E*=v;for(var A=a*=p;A<=m;A+=p)for(var S=l;S<=f;S+=d)for(var F=y;F<=E;F+=v){var M=A+S+F;C[M][P[M]++]=n}}for(R=0;R!==r;R++){var j=(it=s[R]).shape;switch(j.type){case q:var I=it.position.x,O=it.position.y,W=it.position.z,k=j.radius;L(I-k,O-k,W-k,I+k,O+k,W+k,it);break;case z:j.worldNormalNeedsUpdate&&j.computeWorldNormal(it.quaternion);var _=j.worldNormal,Q=w+.5*E-it.position.x,H=b+.5*A-it.position.y,D=g+.5*S-it.position.z,U=new o.Vector3;U.set(Q,H,D);for(var G=0,Y=0;G!==c;G++,Y+=p,U.y=H,U.x+=E)for(var X=0,K=0;X!==h;X++,K+=d,U.z=D,U.y+=A)for(var Z=0,$=0;Z!==u;Z++,$+=v,U.z+=S)if(U.dot(_)<F){var J=Y+K+$;C[J][P[J]++]=it}break;default:it.aabbNeedsUpdate&&it.computeAABB(),L(it.aabb.lowerBound.x,it.aabb.lowerBound.y,it.aabb.lowerBound.z,it.aabb.upperBound.x,it.aabb.upperBound.y,it.aabb.upperBound.z,it)}}for(R=0;R!==T;R++){var tt=P[R];if(tt>1){var et=C[R];for(G=0;G!==tt;G++){var it=et[G];for(X=0;X!==G;X++){var ot=et[X];this.needBroadphaseCollision(it,ot)&&this.intersectionTest(it,ot,e,i)}}}}this.makePairsUnique(e,i)}}class U{constructor(t,e){this.from=t?t.clone():new o.Vector3,this.to=e?e.clone():new o.Vector3,this._direction=new o.Vector3,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=U.ANY,this.result=new k,this.hasHit=!1,this.callback=function(t){}}intersectWorld(t,e){var i=new f,o=[];return this.mode=e.mode||U.ANY,this.result=e.result||new k,this.skipBackfaces=!!e.skipBackfaces,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:-1,e.from&&this.from.copy(e.from),e.to&&this.to.copy(e.to),this.callback=e.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(i),o.length=0,t.broadphase.aabbQuery(t,i,o),this.intersectBodies(o),this.hasHit}intersectBody(t,e){e&&(this.result=e,this._updateDirection());var i=this.checkCollisionResponse;if((!i||t.collisionResponse)&&0!=(this.collisionFilterGroup&t.collisionFilterMask)&&0!=(t.collisionFilterGroup&this.collisionFilterMask))for(var r=new o.Vecot3,s=new o.Quaternion,n=0,a=t.shapes.length;n<a;n++){var l=t.shapes[n];if((!i||l.collisionResponse)&&(t.quaternion.mult(t.shapeOrientations[n],s),t.quaternion.vmult(t.shapeOffsets[n],r),r.vadd(t.position,r),this.intersectShape(l,s,r,t),this.result._shouldStop))break}}intersectBodies(t,e){e&&(this.result=e,this._updateDirection());for(var i=0,o=t.length;!this.result._shouldStop&&i<o;i++)this.intersectBody(t[i])}_updateDirection(){this.to.vsub(this.from,this._direction),this._direction.normalize()}intersectShape(t,e,i,o){if(!(function(t,e,i){var o=new Vec3,r=new Vec3;i.vsub(t,o);var s=o.dot(e);return e.mult(s,r),r.vadd(t,r),i.distanceTo(r)}(this.from,this._direction,i)>t.boundingSphereRadius)){var r=this[t.type];r&&r.call(this,t,e,i,o,t)}}intersectBox(t,e,i,o,r){return this.intersectConvex(t.convexPolyhedronRepresentation,e,i,o,r)}intersectPlane(t,e,i,r,s){var n=this.from,a=this.to,l=this._direction,c=new o.Vector3(0,0,1);e.vmult(c,c);var h=new o.Vector3;n.vsub(i,h);var u=h.dot(c);if(a.vsub(i,h),!(u*h.dot(c)>0||n.distanceTo(a)<u)){var p=c.dot(l);if(!(Math.abs(p)<this.precision)){var d=new o.Vector3,v=new o.Vector3,y=new o.Vector3;n.vsub(i,d);var m=-c.dot(d)/p;l.scale(m,v),n.vadd(v,y),this.reportIntersection(c,y,s,r,-1)}}}getAABB(t){var e=this.to,i=this.from;t.lowerBound.x=Math.min(e.x,i.x),t.lowerBound.y=Math.min(e.y,i.y),t.lowerBound.z=Math.min(e.z,i.z),t.upperBound.x=Math.max(e.x,i.x),t.upperBound.y=Math.max(e.y,i.y),t.upperBound.z=Math.max(e.z,i.z)}intersectHeightfield(t,e,i,o,s){t.data,t.elementSize;var n=intersectHeightfield_localRay;n.from.copy(this.from),n.to.copy(this.to),r.pointToLocalFrame(i,e,n.from,n.from),r.pointToLocalFrame(i,e,n.to,n.to),n._updateDirection();var a,l,c,h,u=intersectHeightfield_index;a=l=0,c=h=t.data.length-1;var p=new f;n.getAABB(p),t.getIndexOfPosition(p.lowerBound.x,p.lowerBound.y,u,!0),a=Math.max(a,u[0]),l=Math.max(l,u[1]),t.getIndexOfPosition(p.upperBound.x,p.upperBound.y,u,!0),c=Math.min(c,u[0]+1),h=Math.min(h,u[1]+1);for(var d=a;d<c;d++)for(var v=l;v<h;v++){if(this.result._shouldStop)return;if(t.getAabbAtIndex(d,v,p),p.overlapsRay(n)){if(t.getConvexTrianglePillar(d,v,!1),r.pointToWorldFrame(i,e,t.pillarOffset,worldPillarOffset),this.intersectConvex(t.pillarConvex,e,worldPillarOffset,o,s,intersectConvexOptions),this.result._shouldStop)return;t.getConvexTrianglePillar(d,v,!0),r.pointToWorldFrame(i,e,t.pillarOffset,worldPillarOffset),this.intersectConvex(t.pillarConvex,e,worldPillarOffset,o,s,intersectConvexOptions)}}}intersectSphere(t,e,i,r,s){new o.Vector3,new U;var n=this.from,a=this.to,l=t.radius,c=Math.pow(a.x-n.x,2)+Math.pow(a.y-n.y,2)+Math.pow(a.z-n.z,2),h=2*((a.x-n.x)*(n.x-i.x)+(a.y-n.y)*(n.y-i.y)+(a.z-n.z)*(n.z-i.z)),u=Math.pow(n.x-i.x,2)+Math.pow(n.y-i.y,2)+Math.pow(n.z-i.z,2)-Math.pow(l,2),p=Math.pow(h,2)-4*c*u,d=new o.Vector3,v=new o.Vector3;if(!(p<0))if(0===p)n.lerp(a,p,d),d.vsub(i,v),v.normalize(),this.reportIntersection(v,d,s,r,-1);else{var y=(-h-Math.sqrt(p))/(2*c),m=(-h+Math.sqrt(p))/(2*c);if(y>=0&&y<=1&&(n.lerp(a,y,d),d.vsub(i,v),v.normalize(),this.reportIntersection(v,d,s,r,-1)),this.result._shouldStop)return;m>=0&&m<=1&&(n.lerp(a,m,d),d.vsub(i,v),v.normalize(),this.reportIntersection(v,d,s,r,-1))}}intersectConvex(t,e,i,r,s,n){new o.Vector3;for(var l=new o.Vector3,h=new o.Vector3,u=(new o.Vector3,n&&n.faceList||null),p=t.faces,d=t.vertices,v=t.faceNormals,y=this._direction,m=this.from,f=this.to,w=m.distanceTo(f),g=u?u.length:p.length,x=this.result,V=0;!x._shouldStop&&V<g;V++){var B=u?u[V]:V,E=p[B],A=v[B],S=e,F=i;h.copy(d[E[0]]),S.vmult(h,h),h.vadd(F,h),h.vsub(m,h),S.vmult(A,l);var M=y.dot(l);if(!(Math.abs(M)<this.precision)){var q=l.dot(h)/M;if(!(q<0)){y.mult(q,intersectPoint),intersectPoint.vadd(m,intersectPoint),a.copy(d[E[0]]),S.vmult(a,a),F.vadd(a,a);for(var z=1;!x._shouldStop&&z<E.length-1;z++){b.copy(d[E[z]]),c.copy(d[E[z+1]]),S.vmult(b,b),S.vmult(c,c),F.vadd(b,b),F.vadd(c,c);var C=intersectPoint.distanceTo(m);!pointInTriangle(intersectPoint,a,b,c)&&!pointInTriangle(intersectPoint,b,a,c)||C>w||this.reportIntersection(l,intersectPoint,s,r,B)}}}}}intersectTrimesh(t,e,i,s,n,l){var h=new o.Vector3,u=[],p=new r,d=(new o.Vector3,new o.Vector3),v=(new o.Vector3,new f,new o.Vector3),y=new o.Vector3,m=new o.Vector3,w=new o.Vector3,g=new o.Vector3,x=(l&&l.faceList,t.indices),V=(t.vertices,t.faceNormals,this.from),B=this.to,E=this._direction;p.position.copy(i),p.quaternion.copy(e),r.vectorToLocalFrame(i,e,E,v),r.pointToLocalFrame(i,e,V,y),r.pointToLocalFrame(i,e,B,m),m.x*=t.scale.x,m.y*=t.scale.y,m.z*=t.scale.z,y.x*=t.scale.x,y.y*=t.scale.y,y.z*=t.scale.z,m.vsub(y,v),v.normalize();var A=y.distanceSquared(m);t.tree.rayQuery(this,p,u);for(var S=0,F=u.length;!this.result._shouldStop&&S!==F;S++){var M=u[S];t.getNormal(M,h),t.getVertex(x[3*M],a),a.vsub(y,d);var q=v.dot(h),z=h.dot(d)/q;if(!(z<0)){v.scale(z,intersectPoint),intersectPoint.vadd(y,intersectPoint),t.getVertex(x[3*M+1],b),t.getVertex(x[3*M+2],c);var C=intersectPoint.distanceSquared(y);!pointInTriangle(intersectPoint,b,a,c)&&!pointInTriangle(intersectPoint,a,b,c)||C>A||(r.vectorToWorldFrame(e,h,g),r.pointToWorldFrame(i,e,intersectPoint,w),this.reportIntersection(g,w,n,s,M))}}u.length=0}reportIntersection(t,e,i,o,r){var s=this.from,n=this.to,a=s.distanceTo(e),l=this.result;if(!(this.skipBackfaces&&t.dot(this._direction)>0))switch(l.hitFaceIndex=void 0!==r?r:-1,this.mode){case U.ALL:this.hasHit=!0,l.set(s,n,t,e,i,o,a),l.hasHit=!0,this.callback(l);break;case U.CLOSEST:(a<l.distance||!l.hasHit)&&(this.hasHit=!0,l.hasHit=!0,l.set(s,n,t,e,i,o,a));break;case U.ANY:this.hasHit=!0,l.hasHit=!0,l.set(s,n,t,e,i,o,a),l._shouldStop=!0}}}U.prototype[n.types.BOX]=U.prototype.intersectBox,U.prototype[n.types.PLANE]=U.prototype.intersectPlane,U.prototype[n.types.HEIGHTFIELD]=U.prototype.intersectHeightfield,U.prototype[n.types.SPHERE]=U.prototype.intersectSphere,U.prototype[n.types.CONVEXPOLYHEDRON]=U.prototype.intersectConvex,U.prototype[n.types.TRIMESH]=U.prototype.intersectTrimesh,U.CLOSEST=1,U.ANY=2,U.ALL=4,U.pointInTriangle=function(t,e,i,o){var r=new Vec3,s=new Vec3;o.vsub(e,v0),i.vsub(e,r),t.vsub(e,s);var n,a,l=v0.dot(v0),c=v0.dot(r),h=v0.dot(s),u=r.dot(r),p=r.dot(s);return(n=u*h-c*p)>=0&&(a=l*p-c*h)>=0&&n+a<l*u-c*c};class G extends Q{constructor(){super()}collisionPairs(t,e,i){for(var o,r,s=t.bodies,n=s.length,a=0;a<n;a++)for(var l=0;l<a;l++)o=s[a],r=s[l],this.needBroadphaseCollision(o,r)&&this.intersectionTest(o,r,e,i)}aabbQuery(t,e,i){i=i||[];for(var o=0;o<t.bodies.length;o++){var r=t.bodies[o];r.aabbNeedsUpdate&&r.computeAABB(),r.aabb.overlaps(e)&&i.push(r)}return i}}class Y{constructor(){this.matrix=[]}get(t,e){if(t=t.index,(e=e.index)>t){var i=e;e=t,t=i}return this.matrix[(t*(t+1)>>1)+e-1]}set(t,e,i){if(t=t.index,(e=e.index)>t){var o=e;e=t,t=o}this.matrix[(t*(t+1)>>1)+e-1]=i?1:0}reset(){for(var t=0,e=this.matrix.length;t!==e;t++)this.matrix[t]=0}setNumObjects(t){this.matrix.length=t*(t-1)>>1}}class X{constructor(){this.matrix={}}get(t,e){if(t=t.id,(e=e.id)>t){var i=e;e=t,t=i}return t+"-"+e in this.matrix}set(t,e,i){if(t=t.id,(e=e.id)>t){var o=e;e=t,t=o}i?this.matrix[t+"-"+e]=!0:delete this.matrix[t+"-"+e]}reset(){this.matrix={}}setNumObjects(t){}}class K{constructor(t,e,i){i=m.defaults(i,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=t,this.bodyB=e,this.id=K.idCounter++,this.collideConnected=i.collideConnected,i.wakeUpBodies&&(t&&t.wakeUp(),e&&e.wakeUp())}update(){throw new Error("method update() not implmemented in this Constraint subclass!")}enable(){for(var t=this.equations,e=0;e<t.length;e++)t[e].enabled=!0}disable(){for(var t=this.equations,e=0;e<t.length;e++)t[e].enabled=!1}}K.idCounter=0;class Z extends K{constructor(t,e,i,r,s){super(t,i),s=void 0!==s?s:1e6,this.pivotA=e?e.clone():new o.Vector3,this.pivotB=r?r.clone():new o.Vector3;var n=this.equationX=new ContactEquation(t,i),a=this.equationY=new ContactEquation(t,i),l=this.equationZ=new ContactEquation(t,i);this.equations.push(n,a,l),n.minForce=a.minForce=l.minForce=-s,n.maxForce=a.maxForce=l.maxForce=s,n.ni.set(1,0,0),a.ni.set(0,1,0),l.ni.set(0,0,1)}update(){var t=this.bodyA,e=this.bodyB,i=this.equationX,o=this.equationY,r=this.equationZ;t.quaternion.vmult(this.pivotA,i.ri),e.quaternion.vmult(this.pivotB,i.rj),o.ri.copy(i.ri),o.rj.copy(i.rj),r.ri.copy(i.ri),r.rj.copy(i.rj)}}class $ extends Z{constructor(t,e,i){var r=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;super(t,i.pivotA?i.pivotA.clone():new o.Vector3,e,i.pivotB?i.pivotB.clone():new o.Vector3,r),(this.axisA=i.axisA?i.axisA.clone():new o.Vector3(1,0,0)).normalize(),(this.axisB=i.axisB?i.axisB.clone():new o.Vector3(1,0,0)).normalize();var s=this.rotationalEquation1=new q(t,e,i),n=this.rotationalEquation2=new q(t,e,i),a=this.motorEquation=new P(t,e,r);a.enabled=!1,this.equations.push(s,n,a)}enableMotor(){this.motorEquation.enabled=!0}disableMotor(){this.motorEquation.enabled=!1}setMotorSpeed(t){this.motorEquation.targetVelocity=t}setMotorMaxForce(t){this.motorEquation.maxForce=t,this.motorEquation.minForce=-t}update(){var t=this.bodyA,e=this.bodyB,i=this.motorEquation,r=this.rotationalEquation1,s=this.rotationalEquation2,n=new o.Vector3,a=new o.Vector3,l=this.axisA,c=this.axisB;super.update(),t.quaternion.vmult(l,n),e.quaternion.vmult(c,a),n.tangents(r.axisA,s.axisA),r.axisB.copy(a),s.axisB.copy(a),this.motorEquation.enabled&&(t.quaternion.vmult(this.axisA,i.axisA),e.quaternion.vmult(this.axisB,i.axisB))}}class J extends Z{constructor(t,e,i){var o=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,r=i.pivotA?i.pivotA.clone():new Vec3,s=i.pivotB?i.pivotB.clone():new Vec3;this.axisA=i.axisA?i.axisA.clone():new Vec3,this.axisB=i.axisB?i.axisB.clone():new Vec3,super(t,r,e,s,o),this.collideConnected=!!i.collideConnected,this.angle=void 0!==i.angle?i.angle:0;var n=this.coneEquation=new z(t,e,i),a=this.twistEquation=new q(t,e,i);this.twistAngle=void 0!==i.twistAngle?i.twistAngle:0,n.maxForce=0,n.minForce=-o,a.maxForce=0,a.minForce=-o,this.equations.push(n,a)}update(){var t=this.bodyA,e=this.bodyB,i=this.coneEquation,o=this.twistEquation;super.update(),t.vectorToWorldFrame(this.axisA,i.axisA),e.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(o.axisA,o.axisA),t.vectorToWorldFrame(o.axisA,o.axisA),this.axisB.tangents(o.axisB,o.axisB),e.vectorToWorldFrame(o.axisB,o.axisB),i.angle=this.angle,o.maxAngle=this.twistAngle}}class tt extends Z{constructor(t,e,i){var r=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,s=new o.Vector3,n=new o.Vector3,a=new o.Vector3;t.position.vadd(e.position,a),a.scale(.5,a),e.pointToLocalFrame(a,n),t.pointToLocalFrame(a,s),Z.call(this,t,s,e,n,r),this.xA=t.vectorToLocalFrame(Vec3.UNIT_X),this.xB=e.vectorToLocalFrame(Vec3.UNIT_X),this.yA=t.vectorToLocalFrame(Vec3.UNIT_Y),this.yB=e.vectorToLocalFrame(Vec3.UNIT_Y),this.zA=t.vectorToLocalFrame(Vec3.UNIT_Z),this.zB=e.vectorToLocalFrame(Vec3.UNIT_Z);var l=this.rotationalEquation1=new q(t,e,i),c=this.rotationalEquation2=new q(t,e,i),h=this.rotationalEquation3=new q(t,e,i);this.equations.push(l,c,h)}update(){var t=this.bodyA,e=this.bodyB,i=(this.motorEquation,this.rotationalEquation1),r=this.rotationalEquation2,s=this.rotationalEquation3;new o.Vector3,new o.Vector3;super.update(),t.vectorToWorldFrame(this.xA,i.axisA),e.vectorToWorldFrame(this.yB,i.axisB),t.vectorToWorldFrame(this.yA,r.axisA),e.vectorToWorldFrame(this.zB,r.axisB),t.vectorToWorldFrame(this.zA,s.axisA),e.vectorToWorldFrame(this.xB,s.axisB)}}class et extends K{constructor(t,e,i,o){super(t,e),void 0===i&&(i=t.position.distanceTo(e.position)),void 0===o&&(o=1e6),this.distance=i;var r=this.distanceEquation=new T(t,e);this.equations.push(r),r.minForce=-o,r.maxForce=o}update(){var t=this.bodyA,e=this.bodyB,i=this.distanceEquation,o=.5*this.distance,r=i.ni;e.position.vsub(t.position,r),r.normalize(),r.mult(o,i.ri),r.mult(-o,i.rj)}}class it{constructor(t){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new S,this.world=t,this.currentContactMaterial=null,this.enableFrictionReduction=!1}createContactEquation(t,e,i,o,r,s){var n;this.contactPointPool.length?((n=this.contactPointPool.pop()).bi=t,n.bj=e):n=new T(t,e),n.enabled=t.collisionResponse&&e.collisionResponse&&i.collisionResponse&&o.collisionResponse;var a=this.currentContactMaterial;n.restitution=a.restitution,n.setSpookParams(a.contactEquationStiffness,a.contactEquationRelaxation,this.world.dt);var l=i.material||t.material,c=o.material||e.material;return l&&c&&l.restitution>=0&&c.restitution>=0&&(n.restitution=l.restitution*c.restitution),n.si=r||i,n.sj=s||o,n}createFrictionEquationsFromContact(t,e){var i=t.bi,o=t.bj,r=t.si,s=t.sj,n=this.world,a=this.currentContactMaterial,l=a.friction,c=r.material||i.material,h=s.material||o.material;if(c&&h&&c.friction>=0&&h.friction>=0&&(l=c.friction*h.friction),l>0){var u=l*n.gravity.length(),p=i.invMass+o.invMass;p>0&&(p=1/p);var d=this.frictionEquationPool,v=d.length?d.pop():new C(i,o,u*p),y=d.length?d.pop():new C(i,o,u*p);return v.bi=y.bi=i,v.bj=y.bj=o,v.minForce=y.minForce=-u*p,v.maxForce=y.maxForce=u*p,v.ri.copy(t.ri),v.rj.copy(t.rj),y.ri.copy(t.ri),y.rj.copy(t.rj),t.ni.tangents(v.t,y.t),v.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,n.dt),y.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,n.dt),v.enabled=y.enabled=t.enabled,e.push(v,y),!0}return!1}createFrictionFromAverage(t){var e=new o.Vector3,i=new o.Vector3,r=new o.Vector3,s=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(s,this.frictionResult)&&1!==t){for(var n=this.frictionResult[this.frictionResult.length-2],a=this.frictionResult[this.frictionResult.length-1],l=s.bi,c=(s.bj,0);c!==t;c++)(s=this.result[this.result.length-1-c]).bodyA!==l?(e.addVectors(s.ni,e),i.addVectors(s.ri,i),r.addVectors(s.rj,r)):(e.vsub(s.ni,e),i.addVectors(s.rj,i),r.addVectors(s.ri,r));var h=1/t;n.ri=(new o.Vector3).copy(i).multiplyScalar(h),n.rj=(new o.Vector3).copy(r).multiplyScalar(h),a.ri.copy(n.ri),a.rj.copy(n.rj),e.normalize(),e.tangents(n.t,a.t)}}getContacts(t,e,i,r,s,n,a){this.contactPointPool=s,this.frictionEquationPool=a,this.result=r,this.frictionResult=n;for(var l=new o.Quaternion,c=new o.Quaternion,h=new o.Vector3,u=new o.Vector3,p=0;p<t.length;p++){var d=t[p],v=e[p],y=null;d.material&&v.material&&(y=i.getContactMaterial(d.material,v.material)||null);for(var m=d.type&w.KINEMATIC&&v.type&w.STATIC||d.type&w.STATIC&&v.type&w.KINEMATIC||d.type&w.KINEMATIC&&v.type&w.KINEMATIC,f=0;f<d.shapes.length;f++){l.multiplyQuaternions(d.quaternion,d.shapeOrientations[f]),h.copy(d.shapeOffsets[f]).applyQuaternion(d.quaternion),h.addVectors(d.position,h);for(var b=d.shapes[f],g=0;g<v.shapes.length;g++){c.multiplyQuaternions(v.quaternion,v.shapeOrientations[g]),u.copy(v.shapeOffsets[g]).applyQuaternion(v.quaternion),u.addVectors(v.position,u);var x=v.shapes[g];if(b.collisionFilterMask&x.collisionFilterGroup&&x.collisionFilterMask&b.collisionFilterGroup&&!(h.distanceTo(u)>b.boundingSphereRadius+x.boundingSphereRadius)){var V=null;b.material&&x.material&&(V=i.getContactMaterial(b.material,x.material)||null),this.currentContactMaterial=V||y||i.defaultContactMaterial;var B=this[b.type|x.type];if(B){(b.type<x.type?B.call(this,b,x,h,u,l,c,d,v,b,x,m):B.call(this,x,b,u,h,c,l,v,d,b,x,m))&&m&&(i.shapeOverlapKeeper.set(b.id,x.id),i.bodyOverlapKeeper.set(d.id,v.id))}}}}}}boxBox(t,e,i,o,r,s,n,a,l,c,h){return t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e.convexPolyhedronRepresentation,i,o,r,s,n,a,t,e,h)}boxConvex(t,e,i,o,r,s,n,a,l,c,h){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e,i,o,r,s,n,a,t,e,h)}boxParticle(t,e,i,o,r,s,n,a,l,c,h){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexParticle(t.convexPolyhedronRepresentation,e,i,o,r,s,n,a,t,e,h)}sphereSphere(t,e,i,o,r,s,n,a,l,c,h){if(h)return i.distanceSquared(o)<Math.pow(t.radius+e.radius,2);var u=this.createContactEquation(n,a,t,e,l,c);o.vsub(i,u.ni),u.ni.normalize(),u.ri.copy(u.ni),u.rj.copy(u.ni),u.ri.mult(t.radius,u.ri),u.rj.mult(-e.radius,u.rj),u.ri.vadd(i,u.ri),u.ri.vsub(n.position,u.ri),u.rj.vadd(o,u.rj),u.rj.vsub(a.position,u.rj),this.result.push(u),this.createFrictionEquationsFromContact(u,this.frictionResult)}planeTrimesh(t,e,i,s,n,a,l,c,h,u,p){var d=new o.Vector3,v=new o.Vector3,y=new o.Vector3,m=new o.Vector3,f=d;f.set(0,0,1),n.vmult(f,f);for(var w=0;w<e.vertices.length/3;w++){e.getVertex(w,m);var b=new o.Vector3;b.copy(m),r.pointToWorldFrame(s,a,b,m);var g=v;if(m.vsub(i,g),f.dot(g)<=0){if(p)return!0;var x=this.createContactEquation(l,c,t,e,h,u);x.ni.copy(f);var V=y;f.scale(g.dot(f),V),m.vsub(V,V),x.ri.copy(V),x.ri.vsub(l.position,x.ri),x.rj.copy(m),x.rj.vsub(c.position,x.rj),this.result.push(x),this.createFrictionEquationsFromContact(x,this.frictionResult)}}}sphereTrimesh(t,e,i,s,n,a,l,c,h,u,p){var d=new o.Vector3,v=new o.Vector3,y=(new o.Vector3,new o.Vector3),m=new o.Vector3,w=new o.Vector3,b=new o.Vector3,g=new o.Vector3,x=new o.Vector3,V=new o.Vector3,B=new o.Vector3,E=new o.Vector3,A=new o.Vector3,S=new o.Vector3,F=w,M=b,q=g,z=x,C=V,P=B,T=new f,R=m,N=v,L=[];r.pointToLocalFrame(s,a,i,C);var j=t.radius;T.lowerBound.set(C.x-j,C.y-j,C.z-j),T.upperBound.set(C.x+j,C.y+j,C.z+j),e.getTrianglesInAABB(T,L);for(var I=y,O=t.radius*t.radius,W=0;W<L.length;W++)for(var k=0;k<3;k++)if(e.getVertex(e.indices[3*L[W]+k],I),I.vsub(C,N),N.norm2()<=O){if(R.copy(I),r.pointToWorldFrame(s,a,R,I),I.vsub(i,N),p)return!0;(H=this.createContactEquation(l,c,t,e,h,u)).ni.copy(N),H.ni.normalize(),H.ri.copy(H.ni),H.ri.scale(t.radius,H.ri),H.ri.vadd(i,H.ri),H.ri.vsub(l.position,H.ri),H.rj.copy(I),H.rj.vsub(c.position,H.rj),this.result.push(H),this.createFrictionEquationsFromContact(H,this.frictionResult)}for(W=0;W<L.length;W++)for(k=0;k<3;k++){e.getVertex(e.indices[3*L[W]+k],F),e.getVertex(e.indices[3*L[W]+(k+1)%3],M),M.vsub(F,q),C.vsub(M,P);var _=P.dot(q);C.vsub(F,P);var Q=P.dot(q);if(Q>0&&_<0)if(C.vsub(F,P),z.copy(q),z.normalize(),Q=P.dot(z),z.scale(Q,P),P.vadd(F,P),(Z=P.distanceTo(C))<t.radius){if(p)return!0;var H=this.createContactEquation(l,c,t,e,h,u);P.vsub(C,H.ni),H.ni.normalize(),H.ni.scale(t.radius,H.ri),r.pointToWorldFrame(s,a,P,P),P.vsub(c.position,H.rj),r.vectorToWorldFrame(a,H.ni,H.ni),r.vectorToWorldFrame(a,H.ri,H.ri),this.result.push(H),this.createFrictionEquationsFromContact(H,this.frictionResult)}}for(var D=E,G=A,Y=S,X=d,K=(W=0,L.length);W!==K;W++){e.getTriangleVertices(L[W],D,G,Y),e.getNormal(L[W],X),C.vsub(D,P);var Z=P.dot(X);if(X.scale(Z,P),C.vsub(P,P),Z=P.distanceTo(C),U.pointInTriangle(P,D,G,Y)&&Z<t.radius){if(p)return!0;H=this.createContactEquation(l,c,t,e,h,u);P.vsub(C,H.ni),H.ni.normalize(),H.ni.scale(t.radius,H.ri),r.pointToWorldFrame(s,a,P,P),P.vsub(c.position,H.rj),r.vectorToWorldFrame(a,H.ni,H.ni),r.vectorToWorldFrame(a,H.ri,H.ri),this.result.push(H),this.createFrictionEquationsFromContact(H,this.frictionResult)}}L.length=0}spherePlane(t,e,i,r,s,n,a,l,c,h,u){var p=new o.Vector3,d=new o.Vector3,v=this.createContactEquation(a,l,t,e,c,h);if(v.ni.set(0,0,1),n.vmult(v.ni,v.ni),v.ni.negate(v.ni),v.ni.normalize(),v.ni.mult(t.radius,v.ri),i.vsub(r,p),v.ni.mult(v.ni.dot(p),d),p.vsub(d,v.rj),-p.dot(v.ni)<=t.radius){if(u)return!0;var y=v.ri,m=v.rj;y.vadd(i,y),y.vsub(a.position,y),m.vadd(r,m),m.vsub(l.position,m),this.result.push(v),this.createFrictionEquationsFromContact(v,this.frictionResult)}}sphereBox(t,e,i,r,s,n,a,l,c,h,u){var p=new o.Vector3,d=new o.Vector3,v=new o.Vector3,y=new o.Vector3,m=[new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3],f=new o.Vector3,w=new o.Vector3,b=new o.Vector3,g=new o.Vector3,x=this.v3pool,V=m;i.vsub(r,p),e.getSideNormals(V,n);for(var B=t.radius,E=!1,A=w,S=b,F=g,M=null,q=0,z=0,C=0,P=null,T=0,R=V.length;T!==R&&!1===E;T++){var N=d;N.copy(V[T]);var L=N.norm();N.normalize();var j=p.dot(N);if(j<L+B&&j>0){var I=v,O=y;I.copy(V[(T+1)%3]),O.copy(V[(T+2)%3]);var W=I.norm(),k=O.norm();I.normalize(),O.normalize();var _=p.dot(I),Q=p.dot(O);if(_<W&&_>-W&&Q<k&&Q>-k){var H=Math.abs(j-L-B);if((null===P||H<P)&&(P=H,z=_,C=Q,M=L,A.copy(N),S.copy(I),F.copy(O),q++,u))return!0}}}if(q){E=!0;var D=this.createContactEquation(a,l,t,e,c,h);A.mult(-B,D.ri),D.ni.copy(A),D.ni.negate(D.ni),A.mult(M,A),S.mult(z,S),A.vadd(S,A),F.mult(C,F),A.vadd(F,D.rj),D.ri.vadd(i,D.ri),D.ri.vsub(a.position,D.ri),D.rj.vadd(r,D.rj),D.rj.vsub(l.position,D.rj),this.result.push(D),this.createFrictionEquationsFromContact(D,this.frictionResult)}for(var U=x.get(),G=f,Y=0;2!==Y&&!E;Y++)for(var X=0;2!==X&&!E;X++)for(var K=0;2!==K&&!E;K++)if(U.set(0,0,0),Y?U.vadd(V[0],U):U.vsub(V[0],U),X?U.vadd(V[1],U):U.vsub(V[1],U),K?U.vadd(V[2],U):U.vsub(V[2],U),r.vadd(U,G),G.vsub(i,G),G.norm2()<B*B){if(u)return!0;E=!0,(D=this.createContactEquation(a,l,t,e,c,h)).ri.copy(G),D.ri.normalize(),D.ni.copy(D.ri),D.ri.mult(B,D.ri),D.rj.copy(U),D.ri.vadd(i,D.ri),D.ri.vsub(a.position,D.ri),D.rj.vadd(r,D.rj),D.rj.vsub(l.position,D.rj),this.result.push(D),this.createFrictionEquationsFromContact(D,this.frictionResult)}x.release(U),U=null;var Z=x.get(),$=x.get(),J=(D=x.get(),x.get()),tt=(H=x.get(),V.length);for(Y=0;Y!==tt&&!E;Y++)for(X=0;X!==tt&&!E;X++)if(Y%3!=X%3){V[X].cross(V[Y],Z),Z.normalize(),V[Y].vadd(V[X],$),D.copy(i),D.vsub($,D),D.vsub(r,D);var et=D.dot(Z);Z.mult(et,J);for(K=0;K===Y%3||K===X%3;)K++;H.copy(i),H.vsub(J,H),H.vsub($,H),H.vsub(r,H);var it=Math.abs(et),ot=H.norm();if(it<V[K].norm()&&ot<B){if(u)return!0;E=!0;var rt=this.createContactEquation(a,l,t,e,c,h);$.vadd(J,rt.rj),rt.rj.copy(rt.rj),H.negate(rt.ni),rt.ni.normalize(),rt.ri.copy(rt.rj),rt.ri.vadd(r,rt.ri),rt.ri.vsub(i,rt.ri),rt.ri.normalize(),rt.ri.mult(B,rt.ri),rt.ri.vadd(i,rt.ri),rt.ri.vsub(a.position,rt.ri),rt.rj.vadd(r,rt.rj),rt.rj.vsub(l.position,rt.rj),this.result.push(rt),this.createFrictionEquationsFromContact(rt,this.frictionResult)}}x.release(Z,$,D,J,H)}sphereConvex(t,e,i,r,s,n,a,l,c,h,u){var p=new o.Vector3,d=new o.Vector3,v=new o.Vector3,y=new o.Vector3,m=new o.Vector3,f=new o.Vector3,w=new o.Vector3,b=new o.Vector3,g=new o.Vector3,x=new o.Vector3,V=this.v3pool;i.vsub(r,p);for(var B=e.faceNormals,E=e.faces,A=e.vertices,S=t.radius,F=0;F!==A.length;F++){var M=A[F],q=m;n.vmult(M,q),r.vadd(q,q);var z=y;if(q.vsub(i,z),z.norm2()<S*S)return!!u||(C=!0,(D=this.createContactEquation(a,l,t,e,c,h)).ri.copy(z),D.ri.normalize(),D.ni.copy(D.ri),D.ri.mult(S,D.ri),q.vsub(r,D.rj),D.ri.vadd(i,D.ri),D.ri.vsub(a.position,D.ri),D.rj.vadd(r,D.rj),D.rj.vsub(l.position,D.rj),this.result.push(D),void this.createFrictionEquationsFromContact(D,this.frictionResult))}for(var C=!1,P=(F=0,E.length);F!==P&&!1===C;F++){var T=B[F],R=E[F],N=f;n.vmult(T,N);var L=w;n.vmult(A[R[0]],L),L.vadd(r,L);var j=b;N.mult(-S,j),i.vadd(j,j);var I=g;j.vsub(L,I);var O=I.dot(N),W=x;if(i.vsub(L,W),O<0&&W.dot(N)>0){for(var k=[],_=0,Q=R.length;_!==Q;_++){var H=V.get();n.vmult(A[R[_]],H),r.vadd(H,H),k.push(H)}if(pointInPolygon(k,N,i)){if(u)return!0;C=!0;var D=this.createContactEquation(a,l,t,e,c,h);N.mult(-S,D.ri),N.negate(D.ni);var U=V.get();N.mult(-O,U);var G=V.get();N.mult(-S,G),i.vsub(r,D.rj),D.rj.vadd(G,D.rj),D.rj.vadd(U,D.rj),D.rj.vadd(r,D.rj),D.rj.vsub(l.position,D.rj),D.ri.vadd(i,D.ri),D.ri.vsub(a.position,D.ri),V.release(U),V.release(G),this.result.push(D),this.createFrictionEquationsFromContact(D,this.frictionResult);_=0;for(var Y=k.length;_!==Y;_++)V.release(k[_]);return}for(_=0;_!==R.length;_++){var X=V.get(),K=V.get();n.vmult(A[R[(_+1)%R.length]],X),n.vmult(A[R[(_+2)%R.length]],K),r.vadd(X,X),r.vadd(K,K);var Z=d;K.vsub(X,Z);var $=v;Z.unit($);var J=V.get(),tt=V.get();i.vsub(X,tt);var et=tt.dot($);$.mult(et,J),J.vadd(X,J);var it=V.get();if(J.vsub(i,it),et>0&&et*et<Z.norm2()&&it.norm2()<S*S){if(u)return!0;D=this.createContactEquation(a,l,t,e,c,h);J.vsub(r,D.rj),J.vsub(i,D.ni),D.ni.normalize(),D.ni.mult(S,D.ri),D.rj.vadd(r,D.rj),D.rj.vsub(l.position,D.rj),D.ri.vadd(i,D.ri),D.ri.vsub(a.position,D.ri),this.result.push(D),this.createFrictionEquationsFromContact(D,this.frictionResult);for(_=0,Y=k.length;_!==Y;_++)V.release(k[_]);return V.release(X),V.release(K),V.release(J),V.release(it),void V.release(tt)}V.release(X),V.release(K),V.release(J),V.release(it),V.release(tt)}for(_=0,Y=k.length;_!==Y;_++)V.release(k[_])}}}planeBox(t,e,i,o,r,s,n,a,l,c,h){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,e.convexPolyhedronRepresentation.id=e.id,this.planeConvex(t,e.convexPolyhedronRepresentation,i,o,r,s,n,a,t,e,h)}planeConvex(t,e,i,r,s,n,a,l,c,h,u){var p=new o.Vector3,d=new o.Vector3(0,1,0);d.applyQuaternion(s);for(var v=0,y=new o.Vector3,m=0;m<e.verticesLength;m++){if(p.copy(e.getVertex(m)),p.applyQuaternion(n),p.addVectors(r,p),y.subVectors(p,i),d.dot(y)<=0){if(u)return!0;var f=this.createContactEquation(a,l,t,e,c,h),w=(new o.Vector3).copy(d).multiplyScalar(d.dot(y));w.subVectors(p,w),f.ri=(new o.Vector3).subVectors(w,i),f.ni.copy(d),f.rj=(new o.Vector3).subVectors(p,r),f.ri.addVectors(i,f.ri),f.ri.subVectors(a.position,f.ri),f.rj.addVectors(r,f.rj),f.rj.subVectors(l.position,f.rj),this.result.push(f),v++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(f,this.frictionResult)}}this.enableFrictionReduction&&v&&this.createFrictionFromAverage(v)}convexConvex(t,e,i,r,s,n,a,l,c,h,u,p,d){var v=new o.Vector3;if(!(i.distanceTo(r)>t.boundingSphereRadius+e.boundingSphereRadius)&&t.findSeparatingAxis(e,i,s,r,n,v,p,d)){var y=[],m=new o.Vector3;t.clipAgainstHull(i,s,e,r,n,v,-100,100,y);for(var f=0,w=0;w!==y.length;w++){if(u)return!0;var b=this.createContactEquation(a,l,t,e,c,h),g=b.ri,x=b.rj;v.negate(b.ni),y[w].normal.negate(m),m.mult(y[w].depth,m),y[w].point.vadd(m,g),x.copy(y[w].point),g.vsub(i,g),x.vsub(r,x),g.vadd(i,g),g.vsub(a.position,g),x.vadd(r,x),x.vsub(l.position,x),this.result.push(b),f++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(b,this.frictionResult)}this.enableFrictionReduction&&f&&this.createFrictionFromAverage(f)}}planeParticle(t,e,i,r,s,n,a,l,c,h,u){var p=new o.Vector3;p.set(0,0,1),a.quaternion.vmult(p,p);var d=new o.Vector3;if(r.vsub(a.position,d),p.dot(d)<=0){if(u)return!0;var v=this.createContactEquation(l,a,e,t,c,h);v.ni.copy(p),v.ni.negate(v.ni),v.ri.set(0,0,0);var y=new o.Vector3;p.mult(p.dot(r),y),r.vsub(y,y),v.rj.copy(y),this.result.push(v),this.createFrictionEquationsFromContact(v,this.frictionResult)}}sphereParticle(t,e,i,r,s,n,a,l,c,h,u){var p=new o.Vector3;if(p.set(0,0,1),r.vsub(i,p),p.norm2()<=t.radius*t.radius){if(u)return!0;var d=this.createContactEquation(l,a,e,t,c,h);p.normalize(),d.rj.copy(p),d.rj.mult(t.radius,d.rj),d.ni.copy(p),d.ni.negate(d.ni),d.ri.set(0,0,0),this.result.push(d),this.createFrictionEquationsFromContact(d,this.frictionResult)}}convexParticle(t,e,i,r,s,n,a,l,c,h,u){var p=new o.Quaternion,d=new o.Vector3,v=-1,y=new o.Vector3,m=new o.Vector3,f=null,w=new o.Vector3;if(w.copy(r),w.vsub(i,w),s.conjugate(p),p.vmult(w,w),t.pointIsInside(w)){t.worldVerticesNeedsUpdate&&t.computeWorldVertices(i,s),t.worldFaceNormalsNeedsUpdate&&t.computeWorldFaceNormals(s);for(var b=0,g=t.faces.length;b!==g;b++){var x=[t.worldVertices[t.faces[b][0]]],V=t.worldFaceNormals[b];r.vsub(x[0],d);var B=-V.dot(d);if(null===f||Math.abs(B)<Math.abs(f)){if(u)return!0;f=B,v=b,y.copy(V),0}}if(-1!==v){var E=this.createContactEquation(l,a,e,t,c,h);y.mult(f,m),m.vadd(r,m),m.vsub(i,m),E.rj.copy(m),y.negate(E.ni),E.ri.set(0,0,0);var A=E.ri,S=E.rj;A.vadd(r,A),A.vsub(l.position,A),S.vadd(i,S),S.vsub(a.position,S),this.result.push(E),this.createFrictionEquationsFromContact(E,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}}boxHeightfield(t,e,i,o,r,s,n,a,l,c,h){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexHeightfield(t.convexPolyhedronRepresentation,e,i,o,r,s,n,a,t,e,h)}convexHeightfield(t,e,i,s,n,a,l,c,h,u,p){var d=e.data,v=e.elementSize,y=t.boundingSphereRadius,m=new o.Vector3,f=[0],w=new o.Vector3;r.pointToLocalFrame(s,a,i,w);var b=Math.floor((w.x-y)/v)-1,g=Math.ceil((w.x+y)/v)+1,x=Math.floor((w.y-y)/v)-1,V=Math.ceil((w.y+y)/v)+1;if(!(g<0||V<0||b>d.length||x>d[0].length)){b<0&&(b=0),g<0&&(g=0),x<0&&(x=0),V<0&&(V=0),b>=d.length&&(b=d.length-1),g>=d.length&&(g=d.length-1),V>=d[0].length&&(V=d[0].length-1),x>=d[0].length&&(x=d[0].length-1);var B=[];e.getRectMinMax(b,x,g,V,B);var E=B[0],A=B[1];if(!(w.z-y>A||w.z+y<E))for(var S=b;S<g;S++)for(var F=x;F<V;F++){var M=!1;if(e.getConvexTrianglePillar(S,F,!1),r.pointToWorldFrame(s,a,e.pillarOffset,m),i.distanceTo(m)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(M=this.convexConvex(t,e.pillarConvex,i,m,n,a,l,c,null,null,p,f,null)),p&&M)return!0;if(e.getConvexTrianglePillar(S,F,!0),r.pointToWorldFrame(s,a,e.pillarOffset,m),i.distanceTo(m)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(M=this.convexConvex(t,e.pillarConvex,i,m,n,a,l,c,null,null,p,f,null)),p&&M)return!0}}}sphereHeightfield(t,e,i,s,n,a,l,c,h,u,p){var d=e.data,v=t.radius,y=e.elementSize,m=new o.Vector3,f=new o.Vector3;r.pointToLocalFrame(s,a,i,f);var w=Math.floor((f.x-v)/y)-1,b=Math.ceil((f.x+v)/y)+1,g=Math.floor((f.y-v)/y)-1,x=Math.ceil((f.y+v)/y)+1;if(!(b<0||x<0||w>d.length||x>d[0].length)){w<0&&(w=0),b<0&&(b=0),g<0&&(g=0),x<0&&(x=0),w>=d.length&&(w=d.length-1),b>=d.length&&(b=d.length-1),x>=d[0].length&&(x=d[0].length-1),g>=d[0].length&&(g=d[0].length-1);var V=[];e.getRectMinMax(w,g,b,x,V);var B=V[0],E=V[1];if(!(f.z-v>E||f.z+v<B))for(var A=this.result,S=w;S<b;S++)for(var F=g;F<x;F++){var M=A.length,q=!1;if(e.getConvexTrianglePillar(S,F,!1),r.pointToWorldFrame(s,a,e.pillarOffset,m),i.distanceTo(m)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(q=this.sphereConvex(t,e.pillarConvex,i,m,n,a,l,c,t,e,p)),p&&q)return!0;if(e.getConvexTrianglePillar(S,F,!0),r.pointToWorldFrame(s,a,e.pillarOffset,m),i.distanceTo(m)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(q=this.sphereConvex(t,e.pillarConvex,i,m,n,a,l,c,t,e,p)),p&&q)return!0;if(A.length-M>2)return}}}}it.numWarnings=0,it.maxWarnings=10,it.prototype[n.types.BOX|n.types.BOX]=it.prototype.boxBox,it.prototype[n.types.BOX|n.types.CONVEXPOLYHEDRON]=it.prototype.boxConvex,it.prototype[n.types.BOX|n.types.PARTICLE]=it.prototype.boxParticle,it.prototype[n.types.SPHERE]=it.prototype.sphereSphere,it.prototype[n.types.PLANE|n.types.TRIMESH]=it.prototype.planeTrimesh,it.prototype[n.types.SPHERE|n.types.TRIMESH]=it.prototype.sphereTrimesh,it.prototype[n.types.SPHERE|n.types.PLANE]=it.prototype.spherePlane,it.prototype[n.types.SPHERE|n.types.BOX]=it.prototype.sphereBox,it.prototype[n.types.SPHERE|n.types.CONVEXPOLYHEDRON]=it.prototype.sphereConvex,it.prototype[n.types.PLANE|n.types.BOX]=it.prototype.planeBox,it.prototype[n.types.PLANE|n.types.CONVEXPOLYHEDRON]=it.prototype.planeConvex,it.prototype[n.types.CONVEXPOLYHEDRON]=it.prototype.convexConvex,it.prototype[n.types.PLANE|n.types.PARTICLE]=it.prototype.planeParticle,it.prototype[n.types.PARTICLE|n.types.SPHERE]=it.prototype.sphereParticle,it.prototype[n.types.PARTICLE|n.types.CONVEXPOLYHEDRON]=it.prototype.convexParticle,it.prototype[n.types.BOX|n.types.HEIGHTFIELD]=it.prototype.boxHeightfield,it.prototype[n.types.CONVEXPOLYHEDRON|n.types.HEIGHTFIELD]=it.prototype.convexHeightfield,it.prototype[n.types.SPHERE|n.types.HEIGHTFIELD]=it.prototype.sphereHeightfield;class ot extends v{constructor(t){t=t||{},super(),this.dt=-1,this.allowSleep=!!t.allowSleep,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=void 0!==t.quatNormalizeSkip?t.quatNormalizeSkip:0,this.quatNormalizeFast=void 0!==t.quatNormalizeFast&&t.quatNormalizeFast,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=t.gravity||new o.Vector3(0,-9.81,0),this.broadphase=void 0!==t.broadphase?t.broadphase:new G,this.bodies=[],this.solver=void 0!==t.solver?t.solver:new W,this.constraints=[],this.narrowphase=new it(this),this.collisionMatrix=new Y,this.collisionMatrixPrevious=new Y,this.bodyOverlapKeeper=new _,this.shapeOverlapKeeper=new _,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new A,this.defaultMaterial=new y("default"),this.defaultContactMaterial=new F(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.accumulator=0,this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.idToBodyMap={},this.broadphase.setWorld(this)}getContactMaterial(t,e){return this.contactMaterialTable.get(t.id,e.id)}numObjects(){return this.bodies.length}collisionMatrixTick(){var t=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=t,this.collisionMatrix.reset(),this.bodyOverlapKeeper.tick(),this.shapeOverlapKeeper.tick()}add(t){-1===this.bodies.indexOf(t)&&(t.index=this.bodies.length,this.bodies.push(t),t.world=this,t.initPosition.copy(t.position),t.initVelocity.copy(t.velocity),t.timeLastSleepy=this.time,t instanceof w&&(t.initAngularVelocity.copy(t.angularVelocity),t.initQuaternion.copy(t.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=t,this.idToBodyMap[t.id]=t,this.dispatchEvent(this.addBodyEvent))}addBody(t){this.add(t)}addConstraint(t){this.constraints.push(t)}removeConstraint(t){var e=this.constraints.indexOf(t);-1!==e&&this.constraints.splice(e,1)}rayTest(t,e,i){i instanceof k?this.raycastClosest(t,e,{skipBackfaces:!0},i):this.raycastAll(t,e,{skipBackfaces:!0},i)}raycastAll(t,e,i,o){return i.mode=U.ALL,i.from=t,i.to=e,i.callback=o,tmpRay.intersectWorld(this,i)}raycastAny(t,e,i,o){return i.mode=U.ANY,i.from=t,i.to=e,i.result=o,tmpRay.intersectWorld(this,i)}raycastClosest(t,e,i,o){return i.mode=U.CLOSEST,i.from=t,i.to=e,i.result=o,tmpRay.intersectWorld(this,i)}remove(t){t.world=null;var e=this.bodies.length-1,i=this.bodies,o=i.indexOf(t);if(-1!==o){i.splice(o,1);for(var r=0;r!==i.length;r++)i[r].index=r;this.collisionMatrix.setNumObjects(e),this.removeBodyEvent.body=t,delete this.idToBodyMap[t.id],this.dispatchEvent(this.removeBodyEvent)}}removeBody(t){this.remove(t)}getBodyById(t){return this.idToBodyMap[t]}getShapeById(t){for(var e=this.bodies,i=0,o=e.length;i<o;i++)for(var r=e[i].shapes,s=0,n=r.length;s<n;s++){var a=r[s];if(a.id===t)return a}}addMaterial(t){this.materials.push(t)}addContactMaterial(t){this.contactmaterials.push(t),this.contactMaterialTable.set(t.materials[0].id,t.materials[1].id,t)}step(t,e,i){if(i=i||10,0===(e=e||0))this.internalStep(t),this.time+=t;else{this.accumulator+=e;for(var o=0;this.accumulator>=t&&o<i;)this.internalStep(t),this.accumulator-=t,o++;for(var r=this.accumulator%t/t,s=0;s!==this.bodies.length;s++){var n=this.bodies[s];n.previousPosition.lerp(n.position,r,n.interpolatedPosition),n.previousQuaternion.slerp(n.quaternion,r,n.interpolatedQuaternion),n.previousQuaternion.normalize()}this.time+=e}}internalStep(t){var e={type:w.COLLIDE_EVENT_NAME,body:null,contact:null};new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Vector3,new o.Quaternion,new o.Quaternion,new o.Quaternion,new o.Vector3;this.dt=t;var i,r=this.contacts,s=[],n=[],a=this.numObjects(),l=this.bodies,c=this.solver,h=this.gravity,u=this.doProfiling,p=this.profile,d=w.DYNAMIC,v=this.constraints,y=[],m=h.x,f=h.y,b=h.z,g=0;for(u&&(i=performance.now()),g=0;g<a;g++){if((q=l[g]).type===d){var x=q.force,V=q.mass;x.x+=V*m,x.y+=V*f,x.z+=V*b}}g=0;for(var B=this.subsystems.length;g<B;g++)this.subsystems[g].update();for(u&&(i=performance.now()),s.length=0,n.length=0,this.broadphase.collisionPairs(this,s,n),u&&(p.broadphase=performance.now()-i),g=0;g<v.length;g++){if(!(T=v[g]).collideConnected)for(var E=s.length-1;E>=0;E-=1)(T.bodyA===s[E]&&T.bodyB===n[E]||T.bodyB===s[E]&&T.bodyA===n[E])&&(s.splice(E,1),n.splice(E,1))}this.collisionMatrixTick(),u&&(i=performance.now());var A=[],S=r.length;for(g=0;g<S;g++)A.push(r[g]);r.length=0;var F=this.frictionEquations.length;for(g=0;g<F;g++)y.push(this.frictionEquations[g]);this.frictionEquations.length=0,this.narrowphase.getContacts(s,n,this,r,A,this.frictionEquations,y),u&&(p.narrowphase=performance.now()-i),u&&(i=performance.now());for(g=0;g<this.frictionEquations.length;g++)c.addEquation(this.frictionEquations[g]);for(var M=0;M<r.length;M++){var q=(T=r[M]).bi,z=T.bj,C=T.si,P=T.sj;(q.material&&z.material&&this.getContactMaterial(q.material,z.material)||this.defaultContactMaterial).friction;if(q.material&&z.material&&(q.material.friction>=0&&z.material.friction>=0&&q.material.friction*z.material.friction,q.material.restitution>=0&&z.material.restitution>=0&&(T.restitution=q.material.restitution*z.material.restitution)),c.addEquation(T),q.allowSleep&&q.type===w.DYNAMIC&&q.sleepState===w.SLEEPING&&z.sleepState===w.AWAKE&&z.type!==w.STATIC)z.velocity.lengthSq()+z.angularVelocity.lengthSq()>=2*Math.pow(z.sleepSpeedLimit,2)&&(q._wakeUpAfterNarrowphase=!0);if(z.allowSleep&&z.type===w.DYNAMIC&&z.sleepState===w.SLEEPING&&q.sleepState===w.AWAKE&&q.type!==w.STATIC)q.velocity.lengthSq()+q.angularVelocity.lengthSq()>=2*Math.pow(q.sleepSpeedLimit,2)&&(z._wakeUpAfterNarrowphase=!0);this.collisionMatrix.set(q,z,!0),this.collisionMatrixPrevious.get(q,z)||(e.body=z,e.contact=T,q.dispatchEvent(e),e.body=q,z.dispatchEvent(e)),this.bodyOverlapKeeper.set(q.id,z.id),this.shapeOverlapKeeper.set(C.id,P.id)}for(this.emitContactEvents(),u&&(p.makeContactConstraints=performance.now()-i,i=performance.now()),g=0;g<a;g++){(q=l[g])._wakeUpAfterNarrowphase&&(q.wakeUp(),q._wakeUpAfterNarrowphase=!1)}for(g=0;g<v.length;g++){var T;(T=v[g]).update();for(E=0;E<T.equations.length;E++){var R=T.equations[E];c.addEquation(R)}}c.solve(t,this),u&&(p.solve=performance.now()-i),c.removeAllEquations();var N=Math.pow;for(g=0;g<a;g++){if((q=l[g]).type&d){var L=N(1-q.linearDamping,t);q.velocity.multiplyScalar(L);var j=q.angularVelocity;if(j){var I=N(1-q.angularDamping,t);j.multiplyScalar(I)}}}for(this.dispatchEvent({type:"preStep"}),g=0;g<a;g++){(q=l[g]).preStep&&q.preStep.call(q)}u&&(i=performance.now());var O=this.stepnumber%(this.quatNormalizeSkip+1)==0,W=this.quatNormalizeFast;for(g=0;g<a;g++)l[g].integrate(t,O,W);for(this.clearForces(),this.broadphase.dirty=!0,u&&(p.integrate=performance.now()-i),this.time+=t,this.stepnumber+=1,this.dispatchEvent({type:"postStep"}),g=0;g<a;g++){var k=(q=l[g]).postStep;k&&k.call(q)}if(this.allowSleep)for(g=0;g<a;g++)l[g].sleepTick(this.time)}emitContactEvents(){var t=[],e=[],i={type:"beginContact",bodyA:null,bodyB:null},o={type:"endContact",bodyA:null,bodyB:null},r={type:"beginShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},s={type:"endShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null};return function(){var n=this.hasAnyEventListener("beginContact"),a=this.hasAnyEventListener("endContact");if((n||a)&&this.bodyOverlapKeeper.getDiff(t,e),n){for(var l=0,c=t.length;l<c;l+=2)i.bodyA=this.getBodyById(t[l]),i.bodyB=this.getBodyById(t[l+1]),this.dispatchEvent(i);i.bodyA=i.bodyB=null}if(a){for(l=0,c=e.length;l<c;l+=2)o.bodyA=this.getBodyById(e[l]),o.bodyB=this.getBodyById(e[l+1]),this.dispatchEvent(o);o.bodyA=o.bodyB=null}t.length=e.length=0;var h=this.hasAnyEventListener("beginShapeContact"),u=this.hasAnyEventListener("endShapeContact");if((h||u)&&this.shapeOverlapKeeper.getDiff(t,e),h){for(l=0,c=t.length;l<c;l+=2){var p=this.getShapeById(t[l]),d=this.getShapeById(t[l+1]);r.shapeA=p,r.shapeB=d,r.bodyA=p.body,r.bodyB=d.body,this.dispatchEvent(r)}r.bodyA=r.bodyB=r.shapeA=r.shapeB=null}if(u){for(l=0,c=e.length;l<c;l+=2){p=this.getShapeById(e[l]),d=this.getShapeById(e[l+1]);s.shapeA=p,s.shapeB=d,s.bodyA=p.body,s.bodyB=d.body,this.dispatchEvent(s)}s.bodyA=s.bodyB=s.shapeA=s.shapeB=null}}}clearForces(){for(var t=0;t<this.bodies.length;t++)this.bodies[t].force.set(0,0,0),this.bodies[t].torque.set(0,0,0)}}i.d(e,"Transform",function(){return r}),i.d(e,"JacobianElement",function(){return s}),i.d(e,"Box",function(){return h}),i.d(e,"ConvexPolyhedron",function(){return l}),i.d(e,"Plane",function(){return u}),i.d(e,"Shape",function(){return n}),i.d(e,"Cylinder",function(){return p}),i.d(e,"Sphere",function(){return d}),i.d(e,"Body",function(){return w}),i.d(e,"Spring",function(){return g}),i.d(e,"SPHSystem",function(){return x}),i.d(e,"Octree",function(){return B}),i.d(e,"Pool",function(){return E}),i.d(e,"Utils",function(){return m}),i.d(e,"TupleDictionary",function(){return A}),i.d(e,"Vec3Pool",function(){return S}),i.d(e,"EventTarget",function(){return v}),i.d(e,"Material",function(){return y}),i.d(e,"ContactMaterial",function(){return F}),i.d(e,"RotationalEquation",function(){return q}),i.d(e,"ConeEquation",function(){return z}),i.d(e,"FrictionEquation",function(){return C}),i.d(e,"Equation",function(){return M}),i.d(e,"RotationalMotorEquation",function(){return P}),i.d(e,"ContactEquation",function(){return T}),i.d(e,"SplitSolver",function(){return N}),i.d(e,"GSSolver",function(){return W}),i.d(e,"Solver",function(){return R}),i.d(e,"RaycastResult",function(){return k}),i.d(e,"OverlapKeeper",function(){return _}),i.d(e,"Broadphase",function(){return Q}),i.d(e,"SAPBroadphase",function(){return H}),i.d(e,"GridBroadphase",function(){return D}),i.d(e,"Ray",function(){return U}),i.d(e,"NaiveBroadphase",function(){return G}),i.d(e,"ArrayCollisionMatrix",function(){return Y}),i.d(e,"AABB",function(){return f}),i.d(e,"ObjectCollisionMatrix",function(){return X}),i.d(e,"Constraint",function(){return K}),i.d(e,"HingeConstraint",function(){return $}),i.d(e,"PointToPointConstraint",function(){return Z}),i.d(e,"ConeTwistConstraint",function(){return J}),i.d(e,"LockConstraint",function(){return tt}),i.d(e,"DistanceConstraint",function(){return et}),i.d(e,"Narrowphase",function(){return it}),i.d(e,"World",function(){return ot}),console.log(["    ██████╗ ██╗  ██╗██╗   ██╗███████╗██╗ ██████╗███████╗    ","    ██╔══██╗██║  ██║╚██╗ ██╔╝██╔════╝██║██╔════╝██╔════╝    ","    ██████╔╝███████║ ╚████╔╝ ███████╗██║██║     ███████╗    ","    ██╔═══╝ ██╔══██║  ╚██╔╝  ╚════██║██║██║     ╚════██║    ","    ██║     ██║  ██║   ██║   ███████║██║╚██████╗███████║    ","    ╚═╝     ╚═╝  ╚═╝   ╚═╝   ╚══════╝╚═╝ ╚═════╝╚══════╝    ","                                                            ","                   ███████╗ ██████╗ ██████╗                 ","                   ██╔════╝██╔═══██╗██╔══██╗                ","                   █████╗  ██║   ██║██████╔╝                ","                   ██╔══╝  ██║   ██║██╔══██╗                ","                   ██║     ╚██████╔╝██║  ██║                ","                   ╚═╝      ╚═════╝ ╚═╝  ╚═╝                ","                                                            ","████████╗██╗  ██╗██████╗ ███████╗███████╗        ██╗███████╗","╚══██╔══╝██║  ██║██╔══██╗██╔════╝██╔════╝        ██║██╔════╝","   ██║   ███████║██████╔╝█████╗  █████╗          ██║███████╗","   ██║   ██╔══██║██╔══██╗██╔══╝  ██╔══╝     ██   ██║╚════██║","   ██║   ██║  ██║██║  ██║███████╗███████╗██╗╚█████╔╝███████║","   ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═╝╚══════╝╚══════╝╚═╝ ╚════╝ ╚══════╝"].join("\n"));var rt=o.Vector3,st=o.Matrix3,nt=o.Quaternion;rt.prototype.almostEquals=function(t,e){return void 0===e&&(e=1e-6),!(Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e)},rt.prototype.almostZero=function(t){return void 0===t&&(t=1e-6),!(Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t)},rt.prototype.tangents=function(t,e){var i=this.length();if(i>0){var r=new o.Vector3,s=1/i;r.set(this.x*s,this.y*s,this.z*s);var n=new o.Vector3;Math.abs(r.x)<.9?(n.set(1,0,0),t=(new o.Vector3).crossVectors(r,n)):(n.set(0,1,0),t=(new o.Vector3).crossVectors(r,n)),e=(new o.Vector3).crossVectors(r,t)}else t.set(1,0,0),e.set(0,1,0)},st.prototype.setRotationFromQuaternion=function(t){var e=t.x,i=t.y,o=t.z,r=t.w,s=e+e,n=i+i,a=o+o,l=e*s,c=e*n,h=e*a,u=i*n,p=i*a,d=o*a,v=r*s,y=r*n,m=r*a,f=this.elements;return f[0]=1-(u+d),f[1]=c-m,f[2]=h+y,f[3]=c+m,f[4]=1-(l+d),f[5]=p-v,f[6]=h-y,f[7]=p+v,f[8]=1-(l+u),this},nt.prototype.integrate=function(t,e,i,o){o=o||new nt;var r=t.x*i.x,s=t.y*i.y,n=t.z*i.z,a=this.x,l=this.y,c=this.z,h=this.w,u=.5*e;return o.x+=u*(r*h+s*c-n*l),o.y+=u*(s*h+n*a-r*c),o.z+=u*(n*h+r*l-s*a),o.w+=u*(-r*a-s*l-n*c),o},nt.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t),this},nt.prototype.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t),this}}])});